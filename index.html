<script>
  // ✅ 여기만 네 Apps Script exec URL로 바꾸기
  const PROXY_URL = "https://script.google.com/macros/s/AKfycbyxy7MyOhgeO1IoVhgqAI6-j4-Vks52a2i28xodKSXA2Bws0_AcQKZDzAjJsS3WvoF-Ww/exec";

  const $  = (q) => document.querySelector(q);

  let header = [];
  let rows   = [];
  let lastTotal = 0;

  function setStatus(msg) {
    $("#status").textContent = msg || "";
  }

  function updateCountInfo() {
    if (!rows.length) {
      $("#countInfo").textContent = "데이터 0행";
      return;
    }
    const shown = rows.length;
    const total = lastTotal || shown;
    $("#countInfo").textContent = `총 ${total}행 중 ${shown}행 표시 (최대 ${shown}행 불러옴)`;
  }

  function renderTable() {
    const table = $("#resultTable");
    table.innerHTML = "";
    if (!header.length) return;

    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    header.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h || "";
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    const tbody = document.createElement("tbody");
    rows.forEach(row => {
      const tr = document.createElement("tr");
      header.forEach((_, idx) => {
        const td = document.createElement("td");
        td.textContent = (row[idx] ?? "").toString();
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);

    $("#pageInfo").textContent = rows.length ? `${rows.length} rows` : "";
  }

  async function searchCustomers() {
    try {
      const q = $("#searchInput").value.trim();
      setStatus("검색 중...");
      $("#resultTable").innerHTML = "";
      $("#pageInfo").textContent = "";
      $("#countInfo").textContent = "데이터 0행";

      // GET /exec?q=검색어
      const url = PROXY_URL + "?q=" + encodeURIComponent(q);
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json(); // {header, rows, total}

      header = data.header || [];
      rows   = data.rows   || [];
      lastTotal = data.total || rows.length;

      updateCountInfo();
      renderTable();

      setStatus("검색 완료");
    } catch (err) {
      console.error(err);
      setStatus("호출 실패: " + (err.message || err));
      alert("결제자 명단 불러오기 실패\n" + (err.message || err));
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // 1) '결제자 명단 불러오기' 버튼 -> 현재 검색어로 검색
    $("#btnFetch").addEventListener("click", (e) => {
      e.preventDefault();
      searchCustomers();
    });

    // 2) 엔터 키로도 검색
    $("#searchInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchCustomers();
      }
    });

    // 3) 검색 초기화
    $("#btnClearSearch").addEventListener("click", (e) => {
      e.preventDefault();
      $("#searchInput").value = "";
      searchCustomers(); // 빈 검색어로 다시 호출 = 전체(앞부분만) 조회
    });
  });
</script>
