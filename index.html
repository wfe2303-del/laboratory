<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìˆ˜ê°•ìƒ ì‹œíŠ¸ ìë™ ì—…ë°ì´íŠ¸ (ì¹´ë“œ + ê³„ì¢Œ Â· Cì—´ ì´ë¦„í‚¤)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;border-radius:10px;background:#0f172a;color:#fff;opacity:.96;box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:1000}
    .scroll-xy{overflow:auto}
    table.preview{border-collapse:collapse}
    table.preview td,table.preview th{border:1px solid #e5e7eb;padding:8px;white-space:nowrap}
    .invalid{background:#fef2f2;color:#991b1b}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-xl md:text-2xl font-bold">ìˆ˜ê°•ìƒ ì‹œíŠ¸ ìë™ ì—…ë°ì´íŠ¸</h1>
      <p class="text-sm text-slate-600 mt-1">ì¢Œ: ì¹´ë“œ CSV Â· ìš°: ê³„ì¢Œ(ì›ì¥ tickets + ì‘ë‹µ responses). ì¹´ë“œ/ê³„ì¢Œ ëª¨ë‘ K(ê²°ì œì‹œê°„/ì…ê¸ˆì¼ì‹œ) ê¸°ì¤€ ì˜¤ë˜ëœâ†’ìµœì‹  ì •ë ¬. ê³„ì¢ŒëŠ” <b>ticketsì˜ Cì—´ ì´ë¦„</b>ìœ¼ë¡œ ì…ê¸ˆâ†”ì¶œê¸ˆ(í™˜ë¶ˆ) ë§¤ì¹­í•©ë‹ˆë‹¤.</p>
    </header>

    <section class="grid lg:grid-cols-2 gap-6 mb-6">
      <!-- ì¹´ë“œ -->
      <div class="space-y-3 bg-white border border-slate-200 rounded-xl p-4">
        <h2 class="font-semibold">â‘  ì¹´ë“œê²°ì œ CSV</h2>
        <input id="csvCard" type="file" accept="text/csv,.csv" class="block w-full text-sm" />
        <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="headCard" class="accent-blue-600" checked /> ì²« í–‰ì€ í—¤ë”(ê±´ë„ˆë›°ê¸°)</label>
      </div>

      <!-- ê³„ì¢Œì´ì²´ -->
      <div class="space-y-3 bg-white border border-slate-200 rounded-xl p-4">
        <h2 class="font-semibold">â‘¡ ê³„ì¢Œì´ì²´ CSV 2ê°œ</h2>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold mb-1">tickets.csv (ì…ì¶œê¸ˆ ì›ì¥ Â· Cì—´=ì´ë¦„)</label>
            <input id="csvTicket" type="file" accept="text/csv,.csv" class="block w-full text-sm" />
            <label class="inline-flex items-center gap-2 text-xs mt-1"><input type="checkbox" id="headTicket" class="accent-blue-600" checked /> ì²« í–‰ì€ í—¤ë”</label>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">responses.csv (ì‹ ì²­/ì‘ë‹µ Â· ì˜µì…˜)</label>
            <input id="csvResp" type="file" accept="text/csv,.csv" class="block w-full text-sm" />
            <label class="inline-flex items-center gap-2 text-xs mt-1"><input type="checkbox" id="headResp" class="accent-blue-600" checked /> ì²« í–‰ì€ í—¤ë”</label>
          </div>
        </div>
        <p class="text-xs text-slate-500">â€» responses ì—†ì´ ticketsë§Œìœ¼ë¡œë„ ë™ì‘í•©ë‹ˆë‹¤. responsesëŠ” ì´ë©”ì¼/ì—°ë½ì²˜ ë³´ê°•ìš©.</p>
      </div>
    </section>

    <!-- ì˜µì…˜ -->
    <section class="grid lg:grid-cols-2 gap-6 mb-6">
      <div class="space-y-3 bg-white border border-slate-200 rounded-xl p-4">
        <h2 class="font-semibold">ë¯¸ë¦¬ë³´ê¸° / ì „ì†¡ ì˜µì…˜</h2>
        <div class="flex items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="optHasHeader" class="accent-blue-600" checked /> ì²« í–‰ì€ í—¤ë”</label>
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="optMaskPhone" class="accent-blue-600" /> ì „í™”ë²ˆí˜¸ ë§ˆìŠ¤í‚¹(ë¯¸ë¦¬ë³´ê¸°)</label>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold mb-1">Google ì‹œíŠ¸ URL ë˜ëŠ” ID</label>
            <input id="sheetUrl" type="text" class="w-full p-3 rounded-lg border border-slate-200 bg-white" placeholder="https://docs.google.com/spreadsheets/d/XXXXXXXXX/edit" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">ì¶”ê°€ ë²”ìœ„ (ì‹œíŠ¸ëª…)</label>
            <input id="rangeA1" type="text" class="w-full p-3 rounded-lg border border-slate-200 bg-white" placeholder="ì˜ˆ: Sheet1" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button id="connectBtn" type="button" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Google ê³„ì • ì—°ê²°</button>
          <select id="valueInputOption" class="p-3 rounded-lg border border-slate-200 bg-white">
            <option value="USER_ENTERED">USER_ENTERED (ê¶Œì¥)</option>
            <option value="RAW">RAW</option>
          </select>
        </div>
        <div class="text-xs text-slate-500">ì „ì†¡ ì‹œ í—¤ë”ëŠ” ìë™ ì œì™¸ë©ë‹ˆë‹¤.</div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <button id="btnPreviewCsv" type="button" class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-black">ì •ë¦¬ ë¯¸ë¦¬ë³´ê¸°</button>
        <button id="btnClear" type="button" class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-100">ì´ˆê¸°í™”</button>
        <button id="btnSend" type="button" class="px-3 py-2 rounded-lg bg-emerald-600 text-white disabled:opacity-50" disabled>Google ì‹œíŠ¸ë¡œ ì „ì†¡</button>
        <span id="authState" class="text-xs text-slate-600 ml-2">ë¯¸ì—°ê²°</span>
      </div>
    </section>

    <!-- Preview -->
    <section class="bg-white rounded-xl border border-slate-200 p-4">
      <div class="flex items-center justify-between mb-3 gap-3">
        <div>
          <h2 class="font-semibold">ì •ë¦¬ ì‹œíŠ¸ ë¯¸ë¦¬ë³´ê¸° <span class="text-xs text-slate-400">(Kì—´ ì˜¤ë¦„ì°¨ìˆœ Â· ì¹´ë“œ í›„ ê³„ì¢Œ)</span></h2>
          <div class="text-xs text-slate-500" id="summary"></div>
        </div>
        <!-- ğŸ” ê²€ìƒ‰ UI ì¶”ê°€ -->
        <div class="flex items-center gap-2">
          <input id="filterText" type="text" class="px-2 py-1 text-xs border border-slate-300 rounded-lg"
                 placeholder="ì´ë¦„/ì—°ë½ì²˜/ê°•ì˜ëª… ê²€ìƒ‰" />
          <button id="btnApplyFilter" type="button" class="px-2 py-1 text-xs rounded-lg border border-slate-300 bg-white hover:bg-slate-100">
            ê²€ìƒ‰ ì ìš©
          </button>
          <button id="btnClearFilter" type="button" class="px-2 py-1 text-xs rounded-lg border border-slate-300 bg-white hover:bg-slate-100">
            ê²€ìƒ‰ í•´ì œ
          </button>
        </div>
      </div>
      <div class="scroll-xy" style="max-height: 520px;">
        <table id="previewTable" class="preview text-sm"></table>
      </div>
    </section>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
  /* =================== ê¸°ë³¸ ì„¤ì • =================== */
  const OAUTH_CLIENT_ID = "18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com"; // ë³¸ì¸ OAuth Client ID
  const OAUTH_SCOPES   = "https://www.googleapis.com/auth/spreadsheets";

  let tokenClient=null, oauthReady=false;
  let parsedRows=[];                 // í—¤ë”+ë³¸ì²´ (full ë°ì´í„°)
  let csvCard=[], csvTickets=[], csvResp=[];
  let filteredRows=null;             // ê²€ìƒ‰ í›„ ê²°ê³¼(í—¤ë”+ë³¸ì²´). ì „ì†¡ì—ëŠ” ì•„ì§ ì‚¬ìš© X

  const $ = (q)=>document.querySelector(q);
  const toast = (msg, type="info")=>{
    const el=$("#toast"); if(!el) return;
    el.textContent=msg; el.classList.remove("hidden");
    el.style.background = type==='error' ? '#991b1b' : (type==='ok' ? '#065f46' : '#0f172a');
    setTimeout(()=> el.classList.add("hidden"), 2600);
  };

  const ensureArrayLen=(len)=>{const a=new Array(len); for(let i=0;i<len;i++) a[i]=''; return a;};
  const equalizeRowLength=(rows)=>{ if(!rows.length) return rows; const m=rows.reduce((p,r)=>Math.max(p,r.length),0); return rows.map(r=>{const c=r.slice(); while(c.length<m) c.push(''); return c;}); };

  const maskPhones=(rows)=>{
    const re1=/(\b\d{3})(\d{4})(\d{4}\b)/g, re2=/(\b\d{2,3}-)(\d{3,4})(-\d{4}\b)/g;
    return rows.map(row=> row.map(cell=>{
      if(typeof cell!=='string') return cell;
      let out=cell.replace(re1,(m,a,b,c)=>`${a}****${c}`);
      out=out.replace(re2,(m,a,b,c)=>`${a}****${c}`);
      return out;
    }));
  };

  const normName=(s)=> String(s||'').trim()
    .replace(/[\s]*[\(\[\{ï¼ˆã€][^)\]\}ï¼‰ã€‘]*[\)\]\}ï¼‰ã€‘]\s*$/,'')
    .replace(/[/_\-\s]+$/,'')
    .replace(/\s+/g,' ')
    .trim();

  function parseMoney(v){
    const s=String(v??'').replace(/[^\d\-\.\,()]/g,'');
    if(!s) return 0;
    let neg=false, t=s;
    if(/\(/.test(t) && /\)/.test(t)) { neg=true; t=t.replace(/[()]/g,''); }
    t=t.replace(/,/g,'');
    if(/^-/.test(t)) neg=!neg;
    const n=parseFloat(t);
    return (neg?-1:1) * (isNaN(n)?0:n);
  }

  function findColIndex(head, names){
    const H=(head||[]).map(x=>String(x||'').toLowerCase().trim());
    for(let i=0;i<H.length;i++){
      for(const nm of names){ if(H[i].includes(String(nm).toLowerCase())) return i; }
    }
    return -1;
  }

  /* =================== ë‚ ì§œ íŒŒì‹± =================== */
  function getTimeFromAny(val){
    if(val===undefined || val===null) return NaN;
    const s0=String(val).trim(); if(!s0) return NaN;
    const pm=/ì˜¤í›„/.test(s0), am=/ì˜¤ì „/.test(s0);
    const m=s0.match(/(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D+(\d{1,2})(?::(\d{1,2})(?::(\d{1,2}))?)?)?/);
    if(m){
      let [,yy,MM,dd,hh,mm,ss]=m;
      let H=hh?parseInt(hh,10):0, Mi=mm?parseInt(mm,10):0, S=ss?parseInt(ss,10):0;
      if(pm && H<12) H+=12; if(am && H===12) H=0;
      return new Date(+yy, +MM-1, +dd, H, Mi, S).getTime();
    }
    const iso=s0.replace(/[./]/g,'-').replace('T',' '); const t=Date.parse(iso);
    return isNaN(t)?NaN:t;
  }

  /* =================== Google API =================== */
  async function ensureGapiLoaded(){
    await new Promise(res=>{const chk=()=>{if(window.gapi && gapi.load){res();} else setTimeout(chk,50);}; chk();});
    await new Promise((res,rej)=>{ gapi.load('client', async ()=>{ try{ await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4'); res(); }catch(e){ rej(e); } }); });
  }
  async function ensureAuth(){
    if(!window.google?.accounts?.oauth2) throw new Error('GIS not loaded');
    if(!tokenClient){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: OAUTH_CLIENT_ID,
        scope: OAUTH_SCOPES,
        callback: (resp)=>{ if(resp?.access_token){ gapi.client.setToken({access_token:resp.access_token}); oauthReady=true; updateAuthUI(); toast('Google ê³„ì • ì—°ê²° ì™„ë£Œ','ok'); } else toast('ì¸ì¦ ì‹¤íŒ¨','error'); }
      });
    }
    if(!oauthReady) tokenClient.requestAccessToken({prompt:'consent'});
  }
  function parseSpreadsheetId(input){ if(!input) return ''; const m=input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); return m && m[1] ? m[1] : input.trim(); }

  async function clearRange(spreadsheetId, range){
    return await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId, range });
  }
  async function writeFromB2(values){
    const spreadsheetId = parseSpreadsheetId($('#sheetUrl').value);
    if(!spreadsheetId) { toast('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL/IDë¥¼ ì…ë ¥í•˜ì„¸ìš”','error'); throw new Error('no sheet'); }
    const sheetName = ($('#rangeA1').value.trim() || 'Sheet1');
    const valueInputOption = $('#valueInputOption').value;

    // âœ… Nì—´ê¹Œì§€ë§Œ ì‚¬ìš©
    await clearRange(spreadsheetId, `${sheetName}!B2:N`);

    // valuesëŠ” A..N(14ì—´) êµ¬ì¡° â†’ B..N(13ì—´)ë§Œ ì „ì†¡
    const valuesBN = values.map(r=>{ const row=Array.isArray(r)?r:[]; const sl=row.slice(1,14); while(sl.length<13) sl.push(''); return sl; });
    const res = await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId,
      range: `${sheetName}!B2`,
      valueInputOption,
      resource: { range: `${sheetName}!B2`, majorDimension:'ROWS', values: valuesBN }
    });
    return res.result?.updatedRows ?? valuesBN.length;
  }

  /* =================== CSV ë¡œë“œ =================== */
  function readCsv(file){
    return new Promise((resolve)=>{
      if(!file){ resolve([]); return; }
      Papa.parse(file,{
        complete:(res)=>{
          let rows=Array.isArray(res.data)?res.data:[]; rows=rows.map(r=>Array.isArray(r)?r:[r]);
          const cnt=rows.filter(r=> r.some(c=> String(c).trim()!=='')).length;
          if(cnt>0){ resolve(rows); return; }
          const tryEnc=['UTF-8','EUC-KR','CP949','ISO-8859-1']; let idx=0;
          const fr=new FileReader();
          fr.onload=()=>{
            const parsed=Papa.parse(String(fr.result||''),{skipEmptyLines:'greedy'});
            let r=Array.isArray(parsed.data)?parsed.data:[]; r=r.map(x=>Array.isArray(x)?x:[x]);
            const c=r.filter(x=>x.some(y=>String(y).trim()!=='')).length;
            if(c>0 || idx>=tryEnc.length-1) resolve(r); else { idx++; fr.readAsText(file, tryEnc[idx]); }
          };
          fr.onerror=()=>resolve([]);
          fr.readAsText(file, tryEnc[idx]);
        },
        error:()=>{
          const fr=new FileReader();
          fr.onload=()=>{
            const parsed=Papa.parse(String(fr.result||''),{skipEmptyLines:'greedy'});
            let r=Array.isArray(parsed.data)?parsed.data:[]; r=r.map(x=>Array.isArray(x)?x:[x]);
            resolve(r);
          };
          fr.onerror=()=>resolve([]);
          fr.readAsText(file,'UTF-8');
        },
        skipEmptyLines:'greedy'
      });
    });
  }

  /* =================== ì‹œíŠ¸ í—¤ë” & ê³µí†µ =================== */
  function buildHeader(){
    // A..N (14ì—´) â€” ì‹¤ì œ ì „ì†¡ì€ B..Në§Œ
    return ['A','B','C','D','E','F','G','H(ê²°ì œê¸ˆì•¡)','I(ìƒíƒœ)','J','K(ê²°ì œì‹œê°„)','L(ê²°ì œìˆ˜ë‹¨)','M(í™˜ë¶ˆê¸ˆì•¡)','N(í™˜ë¶ˆì¼ì‹œ)'];
  }

  // ===== ì¹´ë“œ: A..J â†’ B..K, L='ì‹ ìš©ì¹´ë“œ', M/N = CSV K/L, Kì˜¤ë¦„ì°¨ìˆœ
  function processCardRows(rows, skipHeader=true){
    const out=[]; const start=skipHeader?1:0;
    for(let i=start;i<rows.length;i++){
      const r=rows[i]||[]; if(r.length===0 || r.every(x=>String(x).trim()==='')) continue;
      const o=ensureArrayLen(14); // A..N
      for(let j=0;j<10;j++){ o[1+j]=r[j]??''; } // B..K
      o[11]='ì‹ ìš©ì¹´ë“œ';        // L
      o[12]= r[10] ?? o[12];  // M â† ì¹´ë“œ CSV K (í™˜ë¶ˆê¸ˆì•¡ ë“± ì›ë³¸)
      o[13]= r[11] ?? o[13];  // N â† ì¹´ë“œ CSV L (í™˜ë¶ˆì¼ì‹œ ë“± ì›ë³¸)
      out.push(o);
    }
    out.sort((a,b)=> (getTimeFromAny(a[10])||Infinity) - (getTimeFromAny(b[10])||Infinity));
    return out;
  }

  // ===== ê³„ì¢Œ: tickets(ì…ì¶œê¸ˆ) + responses(ì˜µì…˜) â€” Cì—´ ì´ë¦„í‚¤, ì¶œê¸ˆ=í™˜ë¶ˆë¡œ M/N ì±„ìš°ê¸°
  function makeBankRows(tickets, responses, skipT=true, skipR=true){
    if(!tickets.length) return [];

    // í—¤ë” íƒìƒ‰ (ë‚ ì§œ/ê¸ˆì•¡/êµ¬ë¶„ë§Œ ë™ì  íƒìƒ‰), ì´ë¦„ì€ "ë¬´ì¡°ê±´ Cì—´(index 2)"
    const tHead=tickets[0]||[];
    const cDate = findColIndex(tHead, ['ì¼ì‹œ','ê±°ë˜ì¼ì‹œ','ê±°ë˜ì‹œê°„','ìŠ¹ì¸ì¼ì‹œ','ì²˜ë¦¬ì¼ì‹œ','ë‚ ì§œ','date']);
    const cAmt  = findColIndex(tHead, ['ê¸ˆì•¡','ê±°ë˜ê¸ˆì•¡','ì…ê¸ˆì•¡','ì¶œê¸ˆì•¡','ê¸ˆì•¡(ì›)','amount']);
    const cStat = findColIndex(tHead, ['ìƒíƒœ','ê±°ë˜êµ¬ë¶„','ì…ì¶œê¸ˆ','êµ¬ë¶„','type']);
    const cName = 2; // â˜… Cì—´ì„ ì´ë¦„í‚¤ë¡œ ê³ ì • ì‚¬ìš©

    // responsesë¡œ ì´ë©”ì¼/ì—°ë½ì²˜ ë³´ê°•(ì„ íƒ)
    const rHead=responses[0]||[];
    const rName = findColIndex(rHead, ['ì„±í•¨','ì´ë¦„','ì‹ ì²­ì','name']);
    const rEmail= findColIndex(rHead, ['ì´ë©”ì¼','email']);
    const rPhone= findColIndex(rHead, ['ì—°ë½ì²˜','ì „í™”','íœ´ëŒ€í°','phone']);

    const respMap=new Map();
    const rStart=skipR?1:0;
    if(rName>=0){
      for(let i=rStart;i<responses.length;i++){
        const rr=responses[i]||[];
        const nm=normName(rr[rName]||''); if(!nm) continue;
        if(!respMap.has(nm)) respMap.set(nm,{email:rEmail>=0?(rr[rEmail]||''):'', phone:rPhone>=0?(rr[rPhone]||''):''});
      }
    }

    const depByName=new Map(); // nameN â†’ [{when, paid, row}]
    const refByName=new Map(); // nameN â†’ [{when, amt}]
    const tStart=skipT?1:0;

    for(let i=tStart;i<tickets.length;i++){
      const r=tickets[i]||[]; if(r.every(x=>String(x).trim()==='')) continue;

      const nameRaw = r[cName] ?? '';
      const nameN   = normName(nameRaw);
      if(!nameN) continue;

      // êµ¬ë¶„
      const statRaw=(cStat>=0?String(r[cStat]):'').trim();
      const isDeposit = /ì…ê¸ˆ/.test(statRaw) || /ìˆ˜ì…|ë°›ìŒ|ì…ê¸ˆì™„ë£Œ|deposit/i.test(statRaw);
      const isWithdraw= /ì¶œê¸ˆ/.test(statRaw) || /í™˜ë¶ˆ|ì§€ì¶œ|ë³´ëƒ„|withdraw/i.test(statRaw);

      // ê¸ˆì•¡/ì¼ì‹œ
      const when = cDate>=0 ? (r[cDate]||'') : '';
      const amt  = Math.abs(parseMoney(cAmt>=0 ? r[cAmt] : 0));

      if(isDeposit){
        const meta=respMap.get(nameN)||{email:'',phone:''};
        const row=ensureArrayLen(14); // A..N
        row[3]= nameRaw || '';        // D êµ¬ë§¤ì
        row[4]= meta.phone || '';     // E ì—°ë½ì²˜(ì˜µì…˜)
        row[5]= meta.email || '';     // F ì´ë©”ì¼(ì˜µì…˜)
        row[6]= 'ê°•ì˜';               // G í’ˆëª©(ìƒ˜í”Œ)
        row[7]= amt;                  // H ê²°ì œê¸ˆì•¡(+)
        row[8]= 'ê²°ì œì™„ë£Œ';           // I ìƒíƒœ (í›„ì²˜ë¦¬ì—ì„œ í™˜ë¶ˆë¨/ë¶€ë¶„í™˜ë¶ˆë¡œ ë³€ê²½ ê°€ëŠ¥)
        row[9]= 'ë©´ì„¸';               // J
        row[10]= when;                // K ê²°ì œì‹œê°„(=ì…ê¸ˆì¼ì‹œ)
        row[11]= 'ê³„ì¢Œì´ì²´';          // L ê²°ì œìˆ˜ë‹¨
        row[12]= '';                  // M í™˜ë¶ˆê¸ˆì•¡ (í›„ì²˜ë¦¬)
        row[13]= '';                  // N í™˜ë¶ˆì¼ì‹œ (í›„ì²˜ë¦¬)
        (depByName.get(nameN) || depByName.set(nameN,[]).get(nameN)).push({when, paid:amt, row});
      }else if(isWithdraw){
        const rec={when, amt:amt};
        (refByName.get(nameN) || refByName.set(nameN,[]).get(nameN)).push(rec);
      }
    }

    // ì´ë¦„ë³„ë¡œ ì…ê¸ˆê³¼ ì¶œê¸ˆì„ ìˆœì„œëŒ€ë¡œ ë§¤ì¹­ â†’ M/N ì±„ìš°ê¸°
    const out=[];
    for(const [nameN, deps] of depByName.entries()){
      const refunds=(refByName.get(nameN)||[]).sort((a,b)=> getTimeFromAny(a.when)-getTimeFromAny(b.when));
      const deposits=deps.sort((a,b)=> getTimeFromAny(a.when)-getTimeFromAny(b.when));
      let ri=0;
      for(const d of deposits){
        let remain=d.paid, rsum=0, rdate='';
        while(remain>0 && ri<refunds.length){
          const rf=refunds[ri];
          const take=Math.min(remain, rf.amt);
          rf.amt-=take; remain-=take; rsum+=take; rdate=rf.when;
          if(rf.amt===0) ri++;
        }
        if(rsum>0){ d.row[12]=rsum; d.row[13]=rdate; } // M/N
        d.row[8] = rsum===0 ? 'ê²°ì œì™„ë£Œ' : (rsum>=d.paid ? 'í™˜ë¶ˆë¨' : 'ë¶€ë¶„í™˜ë¶ˆ');
        out.push(d.row);
      }
    }

    // K ì˜¤ë¦„ì°¨ìˆœ(ì˜¤ë˜ëœâ†’ìµœì‹ )
    out.sort((a,b)=> (getTimeFromAny(a[10])||Infinity) - (getTimeFromAny(b[10])||Infinity));
    return out;
  }

  /* =================== ë¹Œë“œ & í”„ë¦¬ë·° =================== */
  function buildHeaderRows(){ return [buildHeader()]; }

  function buildFinalRows(){
    const header=buildHeader();
    const card = csvCard.length ? processCardRows(csvCard, $('#headCard').checked) : [];
    const bank = csvTickets.length ? makeBankRows(csvTickets, csvResp, $('#headTicket').checked, $('#headResp').checked) : [];
    parsedRows=[header, ...card, ...bank]; // ì¹´ë“œ(ì˜¤ë¦„ì°¨ìˆœ) ë’¤ì— ê³„ì¢Œ(ì˜¤ë¦„ì°¨ìˆœ)
    filteredRows=null;
    $('#optHasHeader').checked=true;
  }

  function renderPreview(rows){
    const table=$('#previewTable'); table.innerHTML='';
    if(!rows.length){ $('#summary').textContent='í–‰ 0'; return; }

    const thead=document.createElement('thead');
    const tbody=document.createElement('tbody');
    const colCount=rows[0].length;

    if($('#optHasHeader').checked){
      const tr=document.createElement('tr');
      rows[0].forEach((h,idx)=>{ const th=document.createElement('th'); th.className='bg-slate-100 text-slate-700 font-semibold'; th.textContent=h||`(col${idx+1})`; tr.appendChild(th); });
      thead.appendChild(tr);
    }
    const startIdx=$('#optHasHeader').checked?1:0;
    for(let r=startIdx;r<rows.length;r++){
      const tr=document.createElement('tr'), row=rows[r];
      for(let c=0;c<colCount;c++){
        const td=document.createElement('td'); const v=(row[c]??'').toString();
        if(row.length!==colCount) td.classList.add('invalid');
        td.textContent=v; tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(thead); table.appendChild(tbody);
    const bodyRows=Math.max(0, rows.length-(startIdx));
    const isFiltered = !!filteredRows && filteredRows.length > 0 && rows === filteredRows;
    $('#summary').textContent=`ì—´ ${colCount} Â· ë°ì´í„° í–‰ ${bodyRows}${isFiltered ? ' (ê²€ìƒ‰ ê²°ê³¼)' : ''}`;
  }

  /* =================== ê²€ìƒ‰ ê¸°ëŠ¥ =================== */
  function applyFilter(){
    if(!parsedRows.length){
      toast('ë¨¼ì € ì •ë¦¬ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”','error');
      return;
    }
    const q = ($('#filterText').value || '').trim().toLowerCase();
    if(!q){
      // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì „ì²´ ë°ì´í„°ë¡œ ë³µì›
      filteredRows = null;
      let rows = parsedRows;
      if($('#optMaskPhone').checked) rows = maskPhones(rows);
      rows = equalizeRowLength(rows);
      renderPreview(rows);
      toast('ê²€ìƒ‰ í•´ì œ, ì „ì²´ ë°ì´í„° í‘œì‹œ','ok');
      return;
    }

    const header = parsedRows[0];
    const body = parsedRows.slice(1).filter(row =>
      row.join(' ').toLowerCase().includes(q)
    );
    filteredRows = [header, ...body];

    let rows = filteredRows;
    if($('#optMaskPhone').checked) rows = maskPhones(rows);
    rows = equalizeRowLength(rows);
    renderPreview(rows);
    toast(`ê²€ìƒ‰ ì ìš©: ${body.length}í–‰`, 'ok');
  }

  /* =================== ì´ë²¤íŠ¸ =================== */
  window.addEventListener('error', e=> toast('ì˜¤ë¥˜: '+(e?.error?.message||e.message||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'),'error'));
  window.addEventListener('unhandledrejection', e=> toast('ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜¤ë¥˜: '+(e?.reason?.message||e.reason||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'),'error'));

  document.addEventListener('DOMContentLoaded', ()=>{
    // íŒŒì¼ ì—…ë¡œë“œ
    $('#csvCard').addEventListener('change', async (e)=>{
      try{ const f=e.target.files?.[0]; if(!f){ toast('ì¹´ë“œ CSV ì„ íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤','error'); return; }
        csvCard=await readCsv(f);
        const cnt=csvCard.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()!=='')).length;
        toast(`ì¹´ë“œ CSV ë¡œë“œ: ${csvCard.length}í–‰ (ìœ íš¨ ${cnt}í–‰)`, cnt?'ok':'error');
      }catch(err){ console.error(err); toast('ì¹´ë“œ CSV ì½ê¸° ì‹¤íŒ¨','error'); }
    }, {capture:true});

    $('#csvTicket').addEventListener('change', async (e)=>{
      try{ const f=e.target.files?.[0]; if(!f){ toast('tickets CSV ì„ íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤','error'); return; }
        csvTickets=await readCsv(f);
        const cnt=csvTickets.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()!=='')).length;
        toast(`tickets ë¡œë“œ: ${csvTickets.length}í–‰ (ìœ íš¨ ${cnt}í–‰)`, cnt?'ok':'error');
      }catch(err){ console.error(err); toast('tickets ì½ê¸° ì‹¤íŒ¨','error'); }
    }, {capture:true});

    $('#csvResp').addEventListener('change', async (e)=>{
      try{ const f=e.target.files?.[0]; if(!f){ toast('responses CSV ì„ íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤','error'); return; }
        csvResp=await readCsv(f);
        const cnt=csvResp.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()!=='')).length;
        toast(`responses ë¡œë“œ: ${csvResp.length}í–‰ (ìœ íš¨ ${cnt}í–‰)`, cnt?'ok':'error');
      }catch(err){ console.error(err); toast('responses ì½ê¸° ì‹¤íŒ¨','error'); }
    }, {capture:true});

    // ë¯¸ë¦¬ë³´ê¸°
    $('#btnPreviewCsv').addEventListener('click', (e)=>{
      e.preventDefault();
      try{
        if(!csvCard.length && !csvTickets.length){ parsedRows=buildHeaderRows(); filteredRows=null; renderPreview(parsedRows); toast('CSVë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš” (í—¤ë”ë§Œ í‘œì‹œ)','error'); return; }
        buildFinalRows();
        let rows=parsedRows;
        if($('#optMaskPhone').checked) rows=maskPhones(rows);
        rows=equalizeRowLength(rows);
        renderPreview(rows);
        toast('ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ (ì¹´ë“œâ†’ê³„ì¢Œ, K ì˜¤ë¦„ì°¨ìˆœ)','ok');
      }catch(err){ console.error(err); toast('ì •ë¦¬ ì‹¤íŒ¨: ì½˜ì†” í™•ì¸','error'); }
    });

    // ğŸ” ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸
    $('#btnApplyFilter').addEventListener('click', (e)=>{
      e.preventDefault();
      applyFilter();
    });
    $('#btnClearFilter').addEventListener('click', (e)=>{
      e.preventDefault();
      $('#filterText').value='';
      applyFilter();
    });

    // ì´ˆê¸°í™”
    $('#btnClear').addEventListener('click', (e)=>{
      e.preventDefault();
      csvCard=[]; csvTickets=[]; csvResp=[]; parsedRows=[]; filteredRows=null;
      $('#csvCard').value=''; $('#csvTicket').value=''; $('#csvResp').value='';
      $('#previewTable').innerHTML=''; $('#summary').textContent='';
      $('#filterText').value='';
      toast('ì´ˆê¸°í™” ì™„ë£Œ');
    });

    // Google ì—°ê²°/ì „ì†¡
    $('#connectBtn').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        await ensureGapiLoaded(); await ensureAuth(); $('#btnSend').disabled=false;
      }catch(err){ console.error(err); toast('Google ì—°ê²° ì‹¤íŒ¨','error'); }
    });

    $('#btnSend').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        await ensureGapiLoaded();
        if(!oauthReady){ toast('ë¨¼ì € Google ê³„ì • ì—°ê²°ì„ í•´ì£¼ì„¸ìš”','error'); return; }
        if(!parsedRows.length){ toast('ë¨¼ì € ì •ë¦¬ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”','error'); return; }
        const hasHeader=$('#optHasHeader').checked;
        const rowsToSend=hasHeader? parsedRows.slice(1): parsedRows;
        if(!rowsToSend.length){ toast('ì „ì†¡í•  ë°ì´í„° í–‰ì´ ì—†ìŠµë‹ˆë‹¤','error'); return; }
        $('#btnSend').disabled=true;
        const updated=await writeFromB2(rowsToSend);
        toast(`ì „ì†¡ ì™„ë£Œ: ${updated}í–‰`,'ok');
      }catch(err){ console.error(err); toast('ì „ì†¡ ì‹¤íŒ¨: ì½˜ì†” í™•ì¸','error'); }
      finally{ $('#btnSend').disabled=false; }
    });

    window.updateAuthUI = ()=>{ $('#authState').textContent = oauthReady ? 'ì—°ê²°ë¨' : 'ë¯¸ì—°ê²°'; };
  });
  </script>
</body>
</html>
