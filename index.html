<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìˆ˜ê°•ìƒ ì‹œíŠ¸ ìë™ ì—…ë°ì´íŠ¸ Â· ClassAround</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API (Sheets) -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    body{
      margin:0;
      background:#f1f5f9; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
      color:#0f172a;
      font:13px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    }
    header{
      background:#ffffff;
      border-bottom:1px solid #e2e8f0;
    }
    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      padding:8px 12px;
      border-radius:999px;
      background:#0f172a;
      color:#fff;
      opacity:0;
      box-shadow:0 6px 20px rgba(15,23,42,.35);
      z-index:1000;
      font-size:12px;
      transform:translateY(8px);
      pointer-events:none;
      transition:.22s;
    }
    .toast.show{
      opacity:.97;
      transform:translateY(0);
      pointer-events:auto;
    }
    .scroll-xy{overflow:auto}
    table.preview{border-collapse:collapse;width:100%}
    table.preview td,table.preview th{
      border:1px solid #e2e8f0;
      padding:4px 6px;
      white-space:nowrap;
      font-size:11px;
    }
    table.preview th{
      background:#eff6ff;        /* ì—°íŒŒë‘ í—¤ë” */
      position:sticky;
      top:0;
      z-index:1;
      color:#1e293b;
    }
    .invalid{background:#fef2f2;color:#b91c1c}
    .fname{font-size:11px;color:#64748b;margin-top:3px}
    .badge-blue{
      background:#eff6ff;
      color:#1d4ed8;
      border-radius:999px;
      padding:2px 8px;
      font-size:10px;
      border:1px solid #bfdbfe;
    }
    .tag-red{
      color:#b91c1c;
      font-weight:600;
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- ìƒë‹¨ ë°” -->
  <header>
    <div class="max-w-5xl mx-auto px-4 py-2.5 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <div class="w-7 h-7 rounded-lg bg-gradient-to-tr from-red-500 to-blue-500 flex items-center justify-center text-xs font-bold text-white shadow-sm">
          CA
        </div>
        <div class="flex flex-col">
          <span class="text-xs font-semibold text-slate-900">ìˆ˜ê°•ìƒ ì‹œíŠ¸ ìë™ ì—…ë°ì´íŠ¸</span>
          <span class="text-[11px] text-slate-500"></div>
      </div>
      <div class="flex items-center gap-3 text-[11px]">
        <div class="flex items-center gap-1">
          <span id="authStateDot" class="inline-block w-2 h-2 rounded-full bg-slate-300"></span>
          <span id="authState" class="text-slate-500">Google ì‹œíŠ¸ ì—°ë™ ì¤€ë¹„ ì¤‘</span>
        </div>
        <a href="index.html" class="px-2.5 py-1 rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 text-[11px]">
          ë©”ì¸ìœ¼ë¡œ
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-4 space-y-3">
    <!-- ìƒë‹¨ ì„¤ëª… -->
      </div>
    </section>

    <!-- ì¤‘ë‹¨: ì¢Œì¸¡ ì—…ë¡œë“œ / ìš°ì¸¡ ì‹œíŠ¸ ì„¤ì • + ì‹¤í–‰ ë²„íŠ¼ -->
    <section class="grid md:grid-cols-2 gap-3">
      <!-- ì™¼ìª½: CSV ì—…ë¡œë“œ íŒ¨ë„ -->
      <div class="rounded-xl border border-slate-200 bg-white px-3 py-3 space-y-3 shadow-sm">
        <!-- ì¹´ë“œ CSV -->
        <div class="space-y-1">
          <div class="flex items-center justify-between text-[12px]">
            <div class="flex items-center gap-1.5">
              <span>ğŸ’³</span>
              <span class="font-semibold text-slate-900">ì¹´ë“œê²°ì œ</span>
            </div>
            <span class="text-[10px] text-slate-400"></span>
          </div>
          <input id="csvCard" type="file" accept="text/csv,.csv"
                 class="block w-full text-[12px] cursor-pointer bg-white border border-slate-300 rounded-lg px-2.5 py-1.5 file:mr-2 file:px-2 file:py-1 file:rounded-md file:border-0 file:bg-slate-100 file:text-[11px] file:text-slate-700 file:cursor-pointer" />
          <div id="nameCard" class="fname"></div>
          <label class="inline-flex items-center gap-1.5 text-[11px] mt-0.5 text-slate-600">
            <input type="checkbox" id="headCard" class="accent-blue-600" checked />
            í—¤ë”
          </label>
        </div>

        <div class="h-px bg-slate-100 my-1"></div>

        <!-- ê³„ì¢Œ -->
        <div class="space-y-1">
          <div class="flex items-center justify-between text-[12px]">
            <div class="flex items-center gap-1.5">
              <span>ğŸ¦</span>
              <span class="font-semibold text-slate-900">ê³„ì¢Œì´ì²´</span>
            </div>
            <span class="text-[10px] text-slate-400"></span>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-1">
            <div class="space-y-1">
              <label class="text-[11px] text-slate-600">ì…ì¶œê¸ˆ ì›ì¥</label>
              <input id="csvTicket" type="file" accept="text/csv,.csv"
                     class="block w-full text-[12px] cursor-pointer bg-white border border-slate-300 rounded-lg px-2.5 py-1.5 file:mr-2 file:px-2 file:py-1 file:rounded-md file:border-0 file:bg-slate-100 file:text-[11px] file:text-slate-700 file:cursor-pointer" />
              <div id="nameTicket" class="fname"></div>
              <label class="inline-flex items-center gap-1.5 text-[11px] mt-0.5 text-slate-600">
                <input type="checkbox" id="headTicket" class="accent-blue-600" checked />
                í—¤ë”
              </label>
            </div>

            <div class="space-y-1">
              <label class="text-[11px] text-slate-600">ì‹ ì²­/ì‘ë‹µ</label>
              <input id="csvResp" type="file" accept="text/csv,.csv"
                     class="block w-full text-[12px] cursor-pointer bg-white border border-slate-300 rounded-lg px-2.5 py-1.5 file:mr-2 file:px-2 file:py-1 file:rounded-md file:border-0 file:bg-slate-100 file:text-[11px] file:text-slate-700 file:cursor-pointer" />
              <div id="nameResp" class="fname"></div>
              <label class="inline-flex items-center gap-1.5 text-[11px] mt-0.5 text-slate-600">
                <input type="checkbox" id="headResp" class="accent-blue-600" checked />
                í—¤ë”
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ì‹œíŠ¸ ì„¤ì • + ì‹¤í–‰ ì»¨íŠ¸ë¡¤ -->
      <div class="rounded-xl border border-slate-200 bg-white px-3 py-3 space-y-3 shadow-sm">
        <!-- ì‹œíŠ¸ ì„¤ì • -->
        <div class="space-y-1">
          <div class="flex items-center justify-between text-[12px]">
            <div class="flex items-center gap-1.5">
              <span>ğŸ“„</span>
              <span class="font-semibold text-slate-900">ì‹œíŠ¸ ì„¤ì •</span>
            </div>
          </div>

          <div class="space-y-1.5 mt-1">
            <div>
              <label class="block text-[11px] text-slate-600 mb-0.5">ì‹œíŠ¸ID</label>
              <input id="sheetUrl" type="text"
                     class="w-full bg-white border border-slate-300 rounded-lg px-2.5 py-1.5 text-[12px]"
                     placeholder="https://docs.google.com/spreadsheets/d/XXXXXXXXX/edit" />
            </div>
            <div class="grid grid-cols-3 gap-2 items-end">
              <div class="col-span-2">
                <label class="block text-[11px] text-slate-600 mb-0.5">ì‹œíŠ¸ ì„ íƒ</label>
                <select id="sheetPicker"
                        class="w-full bg-white border border-slate-300 rounded-lg px-2.5 py-1.5 text-[12px]">
                  <option value="">(ì‹œíŠ¸ ëª©ë¡)</option>
                </select>
              </div>
              <div>
                <button id="btnLoadSheets" type="button"
                        class="w-full text-[11px] px-2.5 py-1.5 rounded-full border border-blue-500 bg-white text-blue-600 hover:bg-blue-50">
                  ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="h-px bg-slate-100 my-1"></div>

        <!-- ì˜µì…˜ + ì‹¤í–‰ ë²„íŠ¼ -->
        <div class="space-y-2">
          <div class="flex flex-wrap items-center gap-3 text-[11px] text-slate-600">
            <label class="inline-flex items-center gap-1.5">
              <input type="checkbox" id="optHasHeader" class="accent-blue-600" checked />
              í—¤ë”
            </label>
            <label class="inline-flex items-center gap-1.5">
              <input type="checkbox" id="optMaskPhone" class="accent-blue-600" />
              ì „í™”ë²ˆí˜¸ ë§ˆìŠ¤í‚¹
            </label>
            <div class="flex items-center gap-1">
              <span class="text-slate-500">ê°’ ì…ë ¥ ë°©ì‹</span>
              <select id="valueInputOption"
                      class="bg-white border border-slate-300 rounded-md px-2 py-1 text-[11px]">
                <option value="USER_ENTERED">USER_ENTERED</option>
                <option value="RAW">RAW</option>
              </select>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <button id="btnPreviewCsv" type="button"
                    class="px-3 py-1.5 rounded-full bg-blue-600 text-white text-[12px] font-medium hover:bg-blue-700 shadow-sm">
              ë¯¸ë¦¬ë³´ê¸°
            </button>
            <button id="btnClear" type="button"
                    class="px-3 py-1.5 rounded-full border border-slate-300 bg-white text-slate-700 text-[12px] hover:bg-slate-50">
              ì´ˆê¸°í™”
            </button>
            <button id="btnSend" type="button"
                    class="px-3 py-1.5 rounded-full bg-red-500 text-white text-[12px] font-semibold hover:bg-red-600 shadow-sm">
              ì‹œíŠ¸ë¡œ ì „ì†¡
            </button>
          </div>

          <p class="text-[11px] text-slate-500"></p>
        </div>
      </div>
    </section>

    <!-- ë¯¸ë¦¬ë³´ê¸° -->
    <section class="rounded-xl border border-slate-200 bg-white px-3 py-3 shadow-sm">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2 text-[12px]">
          <span>ğŸ‘€</span>
          <span class="font-semibold text-slate-900">ì‹œíŠ¸ ë¯¸ë¦¬ë³´ê¸°</span>
          <span class="text-[11px] text-slate-500"></span>
        </div>
        <div id="summary" class="text-[11px] text-slate-500"></div>
      </div>
      <div class="scroll-xy" style="max-height: 420px;">
        <table id="previewTable" class="preview"></table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
  /* =================== ê¸°ë³¸ ì„¤ì • =================== */
  const OAUTH_CLIENT_ID = "18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com";
  const OAUTH_SCOPES   = "https://www.googleapis.com/auth/spreadsheets";

  let tokenClient=null, oauthReady=false;
  let parsedRows=[];                 // í—¤ë”+ë³¸ì²´
  let csvCard=[], csvTickets=[], csvResp=[];

  const $ = (q)=>document.querySelector(q);
  const toast = (msg, type="info")=>{
    const el=$("#toast"); if(!el) return;
    el.textContent=msg;
    el.classList.add("show");
    if(type==='error') el.style.background='#b91c1c';      // red
    else if(type==='ok') el.style.background='#15803d';    // green
    else el.style.background='#0f172a';                    // default
    setTimeout(()=> el.classList.remove("show"), 2600);
  };

  const ensureArrayLen=(len)=>{const a=new Array(len); for(let i=0;i<len;i++) a[i]=''; return a;};
  const equalizeRowLength=(rows)=>{ if(!rows.length) return rows; const m=rows.reduce((p,r)=>Math.max(p,r.length),0); return rows.map(r=>{const c=r.slice(); while(c.length<m) c.push(''); return c;}); };

  const maskPhones=(rows)=>{
    const re1=/(\b\d{3})(\d{4})(\d{4}\b)/g, re2=/(\b\d{2,3}-)(\d{3,4})(-\d{4}\b)/g;
    return rows.map(row=> row.map(cell=>{
      if(typeof cell!=='string') return cell;
      let out=cell.replace(re1,(m,a,b,c)=>`${a}****${c}`);
      out=out.replace(re2,(m,a,b,c)=>`${a}****${c}`);
      return out;
    }));
  };

  const normName=(s)=> String(s||'').trim()
    .replace(/[\s]*[\(\[\{ï¼ˆã€][^)\]\}ï¼‰ã€‘]*[\)\]\}ï¼‰ã€‘]\s*$/,'')
    .replace(/[/_\-\s]+$/,'')
    .replace(/\s+/g,' ')
    .trim();

  function parseMoney(v){
    const s=String(v??'').replace(/[^\d\-\.\,()]/g,'');
    if(!s) return 0;
    let neg=false, t=s;
    if(/\(/.test(t) && /\)/.test(t)) { neg=true; t=t.replace(/[()]/g,''); }
    t=t.replace(/,/g,'');
    if(/^-/.test(t)) neg=!neg;
    const n=parseFloat(t);
    return (neg?-1:1) * (isNaN(n)?0:n);
  }

  function findColIndex(head, names){
    const H=(head||[]).map(x=>String(x||'').toLowerCase().trim());
    for(let i=0;i<H.length;i++){
      for(const nm of names){ if(H[i].includes(String(nm).toLowerCase())) return i; }
    }
    return -1;
  }

  /* =================== ë‚ ì§œ íŒŒì‹± =================== */
  function getTimeFromAny(val){
    if(val===undefined || val===null) return NaN;
    const s0=String(val).trim(); if(!s0) return NaN;
    const pm=/ì˜¤í›„/.test(s0), am=/ì˜¤ì „/.test(s0);
    const m=s0.match(/(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D+(\d{1,2})(?::(\d{1,2})(?::(\d{1,2}))?)?)?/);
    if(m){
      let [,yy,MM,dd,hh,mm,ss]=m;
      let H=hh?parseInt(hh,10):0, Mi=mm?parseInt(mm,10):0, S=ss?parseInt(ss,10):0;
      if(pm && H<12) H+=12; if(am && H===12) H=0;
      return new Date(+yy, +MM-1, +dd, H, Mi, S).getTime();
    }
    const iso=s0.replace(/[./]/g,'-').replace('T',' '); const t=Date.parse(iso);
    return isNaN(t)?NaN:t;
  }

  /* =================== Google API =================== */
  async function ensureGapiLoaded(){
    await new Promise(res=>{
      const chk=()=>{if(window.gapi && gapi.load){res();} else setTimeout(chk,50);};
      chk();
    });
    await new Promise((res,rej)=>{
      gapi.load('client', async ()=>{
        try{
          await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');
          res();
        }catch(e){ rej(e); }
      });
    });
  }
  async function ensureAuth(){
    if(!window.google?.accounts?.oauth2) throw new Error('GIS not loaded');
    if(!tokenClient){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: OAUTH_CLIENT_ID,
        scope: OAUTH_SCOPES,
        callback: (resp)=>{
          if(resp?.access_token){
            gapi.client.setToken({access_token:resp.access_token});
            oauthReady=true;
            updateAuthUI();
            toast('Google ì‹œíŠ¸ ê¶Œí•œ í™•ì¸ ì™„ë£Œ','ok');
          } else toast('ì¸ì¦ ì‹¤íŒ¨','error');
        }
      });
    }
    if(!oauthReady) tokenClient.requestAccessToken({prompt:'consent'});
  }
  function parseSpreadsheetId(input){
    if(!input) return '';
    const m=input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    return m && m[1] ? m[1] : input.trim();
  }

  async function listSheets(spreadsheetId){
    const res = await gapi.client.sheets.spreadsheets.get({ spreadsheetId, fields: "sheets(properties(title))" });
    const arr = (res.result?.sheets||[]).map(x=> x.properties?.title).filter(Boolean);
    return arr;
  }

  async function clearRange(spreadsheetId, range){
    return await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId, range });
  }
  async function writeFromB2(values){
    const spreadsheetId = parseSpreadsheetId($('#sheetUrl').value);
    if(!spreadsheetId) { toast('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL/IDë¥¼ ì…ë ¥í•˜ì„¸ìš”','error'); throw new Error('no sheet'); }
    const sheetName = ($('#sheetPicker').value || 'Sheet1');
    const valueInputOption = $('#valueInputOption').value;

    await clearRange(spreadsheetId, `${sheetName}!B2:N`);

    const valuesBN = values.map(r=>{
      const row = Array.isArray(r)? r : [];
      const sl = row.slice(1, 14);
      while(sl.length < 13) sl.push('');
      return sl;
    });

    const res = await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId,
      range: `${sheetName}!B2`,
      valueInputOption,
      resource: { range: `${sheetName}!B2`, majorDimension:'ROWS', values: valuesBN }
    });
    return res.result?.updatedRows ?? valuesBN.length;
  }

  /* =================== CSV ë¡œë“œ =================== */
  function readCsv(file){
    return new Promise((resolve)=>{
      if(!file){ resolve([]); return; }
      Papa.parse(file,{
        complete:(res)=>{
          let rows=Array.isArray(res.data)?res.data:[];
          rows=rows.map(r=> Array.isArray(r)?r:[r]);
          const cnt=rows.filter(r=> r.some(c=> String(c).trim()!=='')).length;
          if(cnt>0){ resolve(rows); return; }
          const tryEnc=['UTF-8','EUC-KR','CP949','ISO-8859-1']; let idx=0;
          const fr=new FileReader();
          fr.onload=()=>{
            const parsed=Papa.parse(String(fr.result||''),{skipEmptyLines:'greedy'});
            let r=Array.isArray(parsed.data)?parsed.data:[];
            r=r.map(x=>Array.isArray(x)?x:[x]);
            const c=r.filter(x=>x.some(y=>String(y).trim()!=='')).length;
            if(c>0 || idx>=tryEnc.length-1) resolve(r);
            else { idx++; fr.readAsText(file, tryEnc[idx]); }
          };
          fr.onerror=()=>resolve([]);
          fr.readAsText(file, tryEnc[idx]);
        },
        error:()=>{
          const fr=new FileReader();
          fr.onload=()=>{
            const parsed=Papa.parse(String(fr.result||''),{skipEmptyLines:'greedy'});
            let r=Array.isArray(parsed.data)?parsed.data:[];
            r=r.map(x=>Array.isArray(x)?x:[x]);
            resolve(r);
          };
          fr.onerror=()=>resolve([]);
          fr.readAsText(file,'UTF-8');
        },
        skipEmptyLines:'greedy'
      });
    });
  }

  /* =================== ì‹œíŠ¸ í—¤ë” & ê³µí†µ =================== */
  function buildHeader(){
    return ['A','B','C','D','E','F','G','H(ê²°ì œê¸ˆì•¡)','I(ìƒíƒœ)','J','K(ê²°ì œì‹œê°„)','L(ê²°ì œìˆ˜ë‹¨)','M(í™˜ë¶ˆê¸ˆì•¡)','N(í™˜ë¶ˆì¼ì‹œ)'];
  }

  function processCardRows(rows, skipHeader=true){
    const out=[]; const start=skipHeader?1:0;
    for(let i=start;i<rows.length;i++){
      const r=rows[i]||[];
      if(r.length===0 || r.every(x=>String(x).trim()==='')) continue;
      const o=ensureArrayLen(14);
      for(let j=0;j<10;j++){ o[1+j]=r[j]??''; }
      o[11]='ì‹ ìš©ì¹´ë“œ';
      o[12]= r[10] ?? o[12];
      o[13]= r[11] ?? o[13];
      out.push(o);
    }
    out.sort((a,b)=> (getTimeFromAny(a[10])||Infinity) - (getTimeFromAny(b[10])||Infinity));
    return out;
  }

  /* ===== ê³„ì¢Œ: êµ­ë¯¼ 9370 ì „ìš© ë¡œì§ ===== */
  function makeBankRows(tickets, responses, skipT=true, skipR=true){
    if(!tickets.length) return [];

    const tHead = tickets[0] || [];
    const cDate = findColIndex(tHead, ['ì¼ì‹œ','ê±°ë˜ì¼ì‹œ','ê±°ë˜ì‹œê°„','ìŠ¹ì¸ì¼ì‹œ','ì²˜ë¦¬ì¼ì‹œ','date','time']);
    const cAmt  = findColIndex(tHead, ['ê¸ˆì•¡','ê±°ë˜ê¸ˆì•¡','ì…ê¸ˆì•¡','ì¶œê¸ˆì•¡','amount']);

    const IDX_GROUP = 12; // Mì—´
    const IDX_TYPE  = 5;  // Fì—´

    const rHead = responses[0] || [];
    const rName = findColIndex(rHead, ['ì„±í•¨','ì´ë¦„','ì‹ ì²­ì','name']);
    const rEmail= findColIndex(rHead, ['ì´ë©”ì¼','email']);
    const rPhone= findColIndex(rHead, ['ì—°ë½ì²˜','ì „í™”','íœ´ëŒ€í°','phone','mobile']);

    const respMap = new Map();
    const rStart  = skipR ? 1 : 0;
    if(rName >= 0){
      for(let i=rStart;i<responses.length;i++){
        const rr = responses[i] || [];
        const nm = normName(rr[rName] || '');
        if(!nm) continue;
        if(!respMap.has(nm)){
          respMap.set(nm, {
            email: rEmail>=0 ? (rr[rEmail] || '') : '',
            phone: rPhone>=0 ? (rr[rPhone] || '') : ''
          });
        }
      }
    }

    const cName = findColIndex(tHead, ['ë³´ë‚¸ë¶„/ë°›ëŠ”ë¶„','ê±°ë˜ìƒëŒ€ëª…','ê±°ë˜ì²˜','ì„±ëª…','ìƒëŒ€']);
    const cPlace= findColIndex(tHead, ['ì‚¬ìš©ì²˜','ì ìš”','ë‚´ìš©','ë©”ëª¨']);
    const cNote = findColIndex(tHead, ['ê³„ì¢Œì ìš”']);
    function pickCounterpartyName(row){
      let s = '';
      if(cNote >= 0) s = row[cNote] || '';
      if(!s && cName >= 0) s = row[cName] || '';
      if(!s && cPlace>= 0) s = row[cPlace] || '';
      s = String(s || '').trim();
      if(!s) return '';
      if(s.includes('â†')) s = s.split('â†')[0];
      if(s.includes('â†’')) s = s.split('â†’')[0];
      return normName(s);
    }

    const groups = new Map();
    const tStart = skipT ? 1 : 0;

    for(let i=tStart;i<tickets.length;i++){
      const r = tickets[i] || [];
      if(r.every(x => String(x).trim() === '')) continue;
      if(r.length <= Math.max(IDX_GROUP, IDX_TYPE)) continue;

      const groupKey = String(r[IDX_GROUP] ?? '').trim();
      if(!groupKey) continue;

      const typeCell = String(r[IDX_TYPE] ?? '').trim();
      const rawAmt   = cAmt>=0 ? parseMoney(r[cAmt]) : 0;
      const when     = cDate>=0 ? (r[cDate] || '') : '';

      const isSale   = typeCell.includes('í˜„ê¸ˆë§¤ì¶œ');
      const isRefund = typeCell.includes('ë§¤ì¶œí™˜ì…ë°ì—ëˆ„ë¦¬');

      if(!isSale && !isRefund) continue;

      let amtSigned = 0;
      if (isSale) {
        amtSigned = Math.abs(rawAmt);
      } else if (isRefund) {
        amtSigned = -Math.abs(rawAmt);
      }

      const nameN = pickCounterpartyName(r);
      let g = groups.get(groupKey);
      if(!g){
        g = { sales: [], refunds: [] };
        groups.set(groupKey, g);
      }

      if(isSale){
        g.sales.push({ when, amt: amtSigned, name: nameN });
      }else if(isRefund){
        g.refunds.push({ when, amt: amtSigned });
      }
    }

    const out = [];

    for(const [groupKey, g] of groups.entries()){
      if(!g.sales.length) continue;

      const saleSum   = g.sales.reduce((s,x)=> s + (x.amt || 0), 0);
      const refundSum = g.refunds.reduce((s,x)=> s + (x.amt || 0), 0);
      const net       = saleSum + refundSum;
      const refundAmount = -refundSum;

      let refundDate = '';
      if(g.refunds.length){
        g.refunds.sort((a,b)=> (getTimeFromAny(a.when)||0) - (getTimeFromAny(b.when)||0));
        refundDate = g.refunds[g.refunds.length - 1].when || '';
      }

      g.sales.sort((a,b)=> (getTimeFromAny(a.when)||0) - (getTimeFromAny(b.when)||0));
      const firstSale = g.sales[0];
      const nameN     = firstSale.name || '';
      const meta      = respMap.get(nameN) || { email:'', phone:'' };

      let status = 'ê²°ì œì™„ë£Œ';
      if(refundAmount > 0){
        status = (net === 0) ? 'í™˜ë¶ˆë¨' : 'ë¶€ë¶„í™˜ë¶ˆ';
      }

      const row = ensureArrayLen(14);

      row[3]  = nameN;
      row[4]  = meta.phone;
      row[5]  = meta.email;
      row[6]  = 'ê°•ì˜';
      row[7]  = saleSum;
      row[8]  = status;
      row[9]  = 'ë©´ì„¸';
      row[10] = firstSale.when;
      row[11] = 'ê³„ì¢Œì´ì²´';
      row[12] = refundAmount || '';
      row[13] = refundDate;

      out.push(row);
    }

    out.sort((a,b)=> (getTimeFromAny(a[10]) || Infinity) - (getTimeFromAny(b[10]) || Infinity));
    return out;
  }

  /* =================== ë¹Œë“œ & í”„ë¦¬ë·° =================== */
  function buildFinalRows(){
    const header=buildHeader();
    const card = csvCard.length ? processCardRows(csvCard, $('#headCard').checked) : [];
    const bank = csvTickets.length ? makeBankRows(csvTickets, csvResp, $('#headTicket').checked, $('#headResp').checked) : [];
    parsedRows=[header, ...card, ...bank];
    $('#optHasHeader').checked=true;
  }

  function renderPreview(rows){
    const table=$('#previewTable'); table.innerHTML='';
    if(!rows.length){ $('#summary').textContent='í–‰ 0'; return; }

    const thead=document.createElement('thead');
    const tbody=document.createElement('tbody');
    const colCount=rows[0].length;

    if($('#optHasHeader').checked){
      const tr=document.createElement('tr');
      rows[0].forEach((h,idx)=>{
        const th=document.createElement('th');
        th.textContent=h||`(col${idx+1})`;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
    }
    const startIdx=$('#optHasHeader').checked?1:0;
    for(let r=startIdx;r<rows.length;r++){
      const tr=document.createElement('tr'), row=rows[r];
      for(let c=0;c<colCount;c++){
        const td=document.createElement('td');
        const v=(row[c]??'').toString();
        if(row.length!==colCount) td.classList.add('invalid');
        td.textContent=v;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(thead);
    table.appendChild(tbody);
    const bodyRows=Math.max(0, rows.length-(startIdx));
    $('#summary').textContent=`ì—´ ${colCount} Â· ë°ì´í„° í–‰ ${bodyRows}`;
  }

  /* =================== ì´ë²¤íŠ¸ =================== */
  window.addEventListener('error', e=> toast('ì˜¤ë¥˜: '+(e?.error?.message||e.message||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'),'error'));
  window.addEventListener('unhandledrejection', e=> toast('ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜¤ë¥˜: '+(e?.reason?.message||e.reason||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'),'error'));

  document.addEventListener('DOMContentLoaded', ()=>{
    // íŒŒì¼ ì—…ë¡œë“œ
    $('#csvCard').addEventListener('change', async (e)=>{
      try{
        const f=e.target.files?.[0];
        if(!f){ toast('ì¹´ë“œ CSV ì„ íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤','error'); return; }
        $('#nameCard').textContent = f.name;
        csvCard=await readCsv(f);
        const cnt=csvCard.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()!=='')).length;
        toast(`ì¹´ë“œ CSV ë¡œë“œ: ${csvCard.length}í–‰ (ìœ íš¨ ${cnt}í–‰)`, cnt?'ok':'error');
      }catch(err){ console.error(err); toast('ì¹´ë“œ CSV ì½ê¸° ì‹¤íŒ¨','error'); }
      finally{ e.target.value=''; }
    }, {capture:true});

    $('#csvTicket').addEventListener('change', async (e)=>{
      try{
        const f=e.target.files?.[0];
        if(!f){ toast('tickets CSV ì„ íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤','error'); return; }
        $('#nameTicket').textContent = f.name;
        csvTickets=await readCsv(f);
        const cnt=csvTickets.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()!=='')).length;
        toast(`tickets ë¡œë“œ: ${csvTickets.length}í–‰ (ìœ íš¨ ${cnt}í–‰)`, cnt?'ok':'error');
      }catch(err){ console.error(err); toast('tickets ì½ê¸° ì‹¤íŒ¨','error'); }
      finally{ e.target.value=''; }
    }, {capture:true});

    $('#csvResp').addEventListener('change', async (e)=>{
      try{
        const f=e.target.files?.[0];
        if(!f){ toast('responses CSV ì„ íƒì´ ë¹„ì—ˆìŠµë‹ˆë‹¤','error'); return; }
        $('#nameResp').textContent = f.name;
        csvResp=await readCsv(f);
        const cnt=csvResp.filter(r=>Array.isArray(r)&&r.some(c=>String(c).trim()!=='')).length;
        toast(`responses ë¡œë“œ: ${csvResp.length}í–‰ (ìœ íš¨ ${cnt}í–‰)`, cnt?'ok':'error');
      }catch(err){ console.error(err); toast('responses ì½ê¸° ì‹¤íŒ¨','error'); }
      finally{ e.target.value=''; }
    }, {capture:true});

    // ë¯¸ë¦¬ë³´ê¸°
    $('#btnPreviewCsv').addEventListener('click', (e)=>{
      e.preventDefault();
      try{
        if(!csvCard.length && !csvTickets.length){
          parsedRows=[buildHeader()];
          renderPreview(parsedRows);
          toast('CSVë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš” (í—¤ë”ë§Œ í‘œì‹œ)','error');
          return;
        }
        buildFinalRows();
        let rows=parsedRows;
        if($('#optMaskPhone').checked) rows=maskPhones(rows);
        rows=equalizeRowLength(rows);
        renderPreview(rows);
        toast('ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ (ì¹´ë“œâ†’ê³„ì¢Œ, K ì˜¤ë¦„ì°¨ìˆœ)','ok');
      }catch(err){ console.error(err); toast('ì •ë¦¬ ì‹¤íŒ¨: ì½˜ì†” í™•ì¸','error'); }
    });

    // ì´ˆê¸°í™”
    $('#btnClear').addEventListener('click', (e)=>{
      e.preventDefault();
      csvCard=[]; csvTickets=[]; csvResp=[]; parsedRows=[];
      $('#csvCard').value=''; $('#csvTicket').value=''; $('#csvResp').value='';
      $('#nameCard').textContent=''; $('#nameTicket').textContent=''; $('#nameResp').textContent='';
      $('#previewTable').innerHTML=''; $('#summary').textContent='';
      toast('ì´ˆê¸°í™” ì™„ë£Œ');
    });

    // ì‹œíŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    $('#btnLoadSheets').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        await ensureGapiLoaded();
        await ensureAuth();
        const spreadsheetId = parseSpreadsheetId($('#sheetUrl').value);
        if(!spreadsheetId){ toast('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL/IDë¥¼ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
        const titles = await listSheets(spreadsheetId);
        const sel = $('#sheetPicker'); sel.innerHTML='';
        if(!titles.length){
          sel.innerHTML = '<option value="">(ì‹œíŠ¸ ì—†ìŒ)</option>';
          return;
        }
        titles.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t; opt.textContent = t;
          sel.appendChild(opt);
        });
        toast(`ì‹œíŠ¸ ${titles.length}ê°œ ë¶ˆëŸ¬ì˜´`,'ok');
      }catch(err){ console.error(err); toast('ì‹œíŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨','error'); }
    });

    // ì „ì†¡
    $('#btnSend').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        await ensureGapiLoaded();
        await ensureAuth();
        if(!parsedRows.length){ toast('ë¨¼ì € ì •ë¦¬ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”','error'); return; }
        const hasHeader=$('#optHasHeader').checked;
        const rowsToSend=hasHeader? parsedRows.slice(1): parsedRows;
        if(!rowsToSend.length){ toast('ì „ì†¡í•  ë°ì´í„° í–‰ì´ ì—†ìŠµë‹ˆë‹¤','error'); return; }
        $('#btnSend').disabled=true;
        const updated=await writeFromB2(rowsToSend);
        toast(`ì „ì†¡ ì™„ë£Œ: ${updated}í–‰`,'ok');
      }catch(err){ console.error(err); toast('ì „ì†¡ ì‹¤íŒ¨: ì½˜ì†” í™•ì¸','error'); }
      finally{ $('#btnSend').disabled=false; }
    });

    window.updateAuthUI = ()=>{
      const dot = $('#authStateDot');
      const label = $('#authState');
      if(!dot || !label) return;
      if(oauthReady){
        dot.style.background = '#22c55e';
        label.textContent = 'Google ì‹œíŠ¸ ì—°ë™ ì™„ë£Œ';
      }else{
        dot.style.background = '#cbd5f5';
        label.textContent = 'Google ì‹œíŠ¸ ì—°ë™ í•„ìš” ì‹œ ìë™ ìš”ì²­';
      }
    };
    updateAuthUI();
  });
  </script>
</body>
</html>
