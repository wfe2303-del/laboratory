<script>
  // ðŸ”´ ì—¬ê¸°ë§Œ Apps Script exec URLë¡œ ë°”ê¾¸ê¸°
  const PROXY_URL = "https://script.google.com/macros/s/AKfycbwecyIkPVRsPEBMAtYUl0XLNpt0g_4-VMBY7YSLbN65fBSce8M4jwIbv0EblspkSuQr/exec";

  const $  = (q) => document.querySelector(q);

  let header = [];
  let rows   = [];
  let lastTotal = 0;
  let lastJsonpScript = null; // JSONP ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ê¸°ì–µìš©

  function setStatus(msg) {
    $("#status").textContent = msg || "";
  }

  function updateCountInfo() {
    if (!rows.length) {
      $("#countInfo").textContent = "ë°ì´í„° 0í–‰";
      return;
    }
    const shown = rows.length;
    const total = lastTotal || shown;
    $("#countInfo").textContent =
      `ì´ ${total}í–‰ ì¤‘ ${shown}í–‰ í‘œì‹œ (ìµœëŒ€ ${shown}í–‰ ë¶ˆëŸ¬ì˜´)`;
  }

  function renderTable() {
    const table = $("#resultTable");
    table.innerHTML = "";
    if (!header.length) return;

    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    header.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h || "";
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    const tbody = document.createElement("tbody");
    rows.forEach(row => {
      const tr = document.createElement("tr");
      header.forEach((_, idx) => {
        const td = document.createElement("td");
        td.textContent = (row[idx] ?? "").toString();
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);

    $("#pageInfo").textContent = rows.length ? `${rows.length} rows` : "";
  }

  // Apps Scriptì—ì„œ JSONPë¡œ í˜¸ì¶œí•´ ì¤„ ì½œë°±
  function cojobooCallback(data) {
    try {
      console.log("JSONP ì‘ë‹µ:", data);
      header = data.header || [];
      rows   = data.rows   || [];
      lastTotal = data.total || rows.length;

      updateCountInfo();
      renderTable();
      setStatus("ê²€ìƒ‰ ì™„ë£Œ");
    } catch (err) {
      console.error("cojobooCallback error:", err);
      setStatus("ì‘ë‹µ ì²˜ë¦¬ ì‹¤íŒ¨: " + (err.message || err));
      alert("ì‘ë‹µ ì²˜ë¦¬ ì‹¤íŒ¨\n" + (err.message || err));
    } finally {
      // script íƒœê·¸ í•œ ë²ˆ ì“°ê³  ì œê±° (ì•ˆ í•´ë„ ë˜ì§€ë§Œ ê¹”ë”í•˜ê²Œ)
      if (lastJsonpScript && lastJsonpScript.parentNode) {
        lastJsonpScript.parentNode.removeChild(lastJsonpScript);
        lastJsonpScript = null;
      }
    }
  }

  // ì „ì—­ì— ë‹¬ì•„ì£¼ê¸° (JSONPì—ì„œëŠ” window.cojobooCallback(...) í˜•íƒœë¡œ ì‹¤í–‰ë¨)
  window.cojobooCallback = cojobooCallback;

  function searchCustomers() {
    const q = $("#searchInput").value.trim();
    setStatus("ê²€ìƒ‰ ì¤‘...");
    $("#resultTable").innerHTML = "";
    $("#pageInfo").textContent = "";
    $("#countInfo").textContent = "ë°ì´í„° 0í–‰";

    // ì´ì „ JSONP ìŠ¤í¬ë¦½íŠ¸ ì œê±°
    if (lastJsonpScript && lastJsonpScript.parentNode) {
      lastJsonpScript.parentNode.removeChild(lastJsonpScript);
      lastJsonpScript = null;
    }

    // JSONPìš© script íƒœê·¸ ìƒì„±
    const script = document.createElement("script");
    const url =
      PROXY_URL +
      "?q=" + encodeURIComponent(q) +
      "&callback=cojobooCallback" +
      "&_ts=" + Date.now(); // ìºì‹œ ë°©ì§€ìš©

    script.src = url;
    script.onerror = function(err) {
      console.error("JSONP script error:", err);
      setStatus("í˜¸ì¶œ ì‹¤íŒ¨ (JSONP ë¡œë“œ ì—ëŸ¬)");
      alert("ê²°ì œìž ëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨(JSONP ë¡œë“œ ì—ëŸ¬)");
    };

    lastJsonpScript = script;
    document.body.appendChild(script);
  }

  document.addEventListener("DOMContentLoaded", () => {
    $("#btnFetch").addEventListener("click", (e) => {
      e.preventDefault();
      searchCustomers();
    });

    $("#searchInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchCustomers();
      }
    });

    $("#btnClearSearch").addEventListener("click", (e) => {
      e.preventDefault();
      $("#searchInput").value = "";
      searchCustomers();
    });
  });
</script>
