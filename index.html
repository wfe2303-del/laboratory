<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>코주부 결제자 명단 검색</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    table { border-collapse: collapse; font-size: 12px; }
    th, td { border:1px solid #e5e7eb; padding:4px 6px; white-space:nowrap; }
    th { background:#f1f5f9; }
    .highlight { background:#fef3c7; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4 space-y-4">

    <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-lg font-bold">코주부 결제자 명단 검색</h1>
        <p class="text-xs text-slate-500 mt-1">
          Apps Script 프록시를 통해 <code>toss-customers</code> CSV를 불러와 검색합니다.
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="btnFetch"
          class="px-3 py-2 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700">
          결제자 명단 불러오기
        </button>
        <span id="status" class="text-xs text-slate-600"></span>
      </div>
    </header>

    <!-- 검색 / 필터 영역 -->
    <section class="bg-white border border-slate-200 rounded-xl p-3 flex flex-wrap gap-3 items-center">
      <div class="flex-1 min-w-[180px]">
        <label class="block text-xs text-slate-500 mb-1">검색어 (이름, 연락처, 강의명 등 전체열 검색)</label>
        <input id="searchInput" type="text"
               class="w-full border border-slate-200 rounded-md px-3 py-1.5 text-sm"
               placeholder="예: 홍길동, 010-1234, 강의명 일부 등" />
      </div>
      <div class="flex items-center gap-2 text-xs text-slate-500">
        <span id="countInfo">데이터 0행</span>
        <button id="btnClearSearch"
                class="px-2 py-1 border border-slate-300 rounded-md text-xs bg-slate-50 hover:bg-slate-100">
          검색 초기화
        </button>
      </div>
    </section>

    <!-- 결과 테이블 -->
    <section class="bg-white border border-slate-200 rounded-xl p-3">
      <div class="mb-2 text-xs text-slate-500 flex justify-between items-center">
        <span>결제자 리스트</span>
        <span id="pageInfo"></span>
      </div>
      <div class="overflow-auto max-h-[520px]">
        <table id="resultTable" class="w-full"></table>
      </div>
    </section>
  </div>

  <script>
    // ✅ 1) 여기만 네 Apps Script 웹앱 URL로 바꾸면 됨
    const PROXY_URL = "https://script.google.com/macros/s/AKfycbxdPuoubLcm5cgitCNmhq0DR4QMrUxgelpGKoNqVLu01I07pJpB0WPGzZ4l4oGx0nD2JQ/exec";

    const $  = (q) => document.querySelector(q);

    let rawRows = [];      // CSV 전체 (배열의 배열)
    let header  = [];      // 첫 행 (헤더)
    let rows    = [];      // 헤더 제외 실제 데이터
    let filteredRows = []; // 검색 필터링 결과

    function setStatus(msg) {
      $("#status").textContent = msg || "";
    }

    function updateCountInfo() {
      const total = rows.length;
      const shown = filteredRows.length;
      $("#countInfo").textContent =
        total === 0
          ? "데이터 0행"
          : `총 ${total}행 중 ${shown}행 표시`;
    }

    function renderTable() {
      const table = $("#resultTable");
      table.innerHTML = "";
      if (!header.length && !filteredRows.length) return;

      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");
      header.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h || "";
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      const tbody = document.createElement("tbody");
      filteredRows.forEach(row => {
        const tr = document.createElement("tr");
        header.forEach((_, idx) => {
          const td = document.createElement("td");
          td.textContent = (row[idx] ?? "").toString();
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);

      $("#pageInfo").textContent = filteredRows.length
        ? `${filteredRows.length} rows`
        : "";
    }

    function applySearch() {
      const q = $("#searchInput").value.trim().toLowerCase();
      if (!q) {
        filteredRows = rows.slice();
        updateCountInfo();
        renderTable();
        return;
      }

      filteredRows = rows.filter(row =>
        row.some(cell =>
          (cell ?? "").toString().toLowerCase().includes(q)
        )
      );
      updateCountInfo();
      renderTable();
    }

    async function fetchCustomers() {
      try {
        setStatus("불러오는 중...");
        $("#resultTable").innerHTML = "";
        $("#pageInfo").textContent = "";
        $("#countInfo").textContent = "데이터 0행";

        const res = await fetch(PROXY_URL);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();

        const parsed = Papa.parse(text, { skipEmptyLines: "greedy" });
        if (!parsed.data || !parsed.data.length) {
          throw new Error("CSV 데이터가 비어 있습니다");
        }
        rawRows = parsed.data;

        // 1행 헤더, 나머지는 데이터
        header = rawRows[0].map(x => (x ?? "").toString());
        rows   = rawRows.slice(1);

        filteredRows = rows.slice();
        updateCountInfo();
        renderTable();

        setStatus("불러오기 완료");
      } catch (err) {
        console.error(err);
        setStatus("호출 실패: " + (err.message || err));
        alert("결제자 명단 불러오기 실패\n" + (err.message || err));
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      $("#btnFetch").addEventListener("click", (e) => {
        e.preventDefault();
        fetchCustomers();
      });

      $("#searchInput").addEventListener("input", () => {
        applySearch();
      });

      $("#btnClearSearch").addEventListener("click", (e) => {
        e.preventDefault();
        $("#searchInput").value = "";
        applySearch();
      });
    });
  </script>
</body>
</html>

