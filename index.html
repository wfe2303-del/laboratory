<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>오픈카톡 인원수 체크 (GitHub Pages)</title>
<style>
  :root{ --white:#fff; --blue:#2563eb; --red:#ef4444; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; }
  *{box-sizing:border-box} body{margin:0;background:var(--white);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo',Arial}
  .wrap{max-width:760px;margin:0 auto;padding:20px}
  h1{margin:0 0 12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
  label{font-weight:700}
  input,button{height:42px;border-radius:10px;border:1px solid var(--line);padding:0 12px}
  button{background:var(--blue);border-color:var(--blue);color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:var(--blue)}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px}
  .result{padding:10px;border:1px dashed var(--line);border-radius:10px;background:#f8fafc}
  .ok{color:#16a34a;font-weight:700}.fail{color:#ef4444;font-weight:700}.muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<div class="wrap">
  <h1>오픈카톡 인원수 체크</h1>
  <p class="muted">공개 오픈톡 링크를 붙여넣으면 <b>r.jina.ai</b> 프록시로 HTML을 받아 <b>“…명”</b> 텍스트를 파싱합니다.</p>
  <div class="card">
    <label for="url">오픈카톡 링크</label>
    <div class="row" style="margin-top:6px">
      <input id="url" placeholder="https://open.kakao.com/o/..." />
      <button id="go" type="button">인원수 체크</button>
    </div>
    <p class="muted" style="margin:8px 0 0">예) <span class="mono">https://open.kakao.com/o/XXXXXX</span></p>
  </div>
  <div class="card">
    <h3 style="margin:0 0 8px">결과</h3>
    <div id="out" class="result muted">아직 결과가 없습니다.</div>
  </div>
</div>
<script>
(function(){
  const $ = s=>document.querySelector(s);
  const out = $('#out');
  const show = (msg,cls='muted')=>{ out.className='result '+cls; out.innerHTML=msg; };
  function norm(u){ return /^https?:\/\//i.test(u)? u : 'https://'+u; }
  function proxy(u){ const x = new URL(norm(u)); const p = x.protocol.replace(':',''); return `https://r.jina.ai/${p}://${x.host}${x.pathname}${x.search}`; }
  function parseCount(t){ const re=/(\d{1,3}(?:,\d{3})*|\d+)\s*명/g; let m,b=null; while((m=re.exec(t))){ const n=parseInt(m[1].replace(/,/g,''),10); if(!Number.isNaN(n)) b=b==null?n:Math.max(b,n);} return b; }
  async function fetchText(u,ms=8000){ const ctl=new AbortController(); const id=setTimeout(()=>ctl.abort(),ms); try{ const r=await fetch(u,{signal:ctl.signal}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.text(); } finally{ clearTimeout(id); } }
  $('#go').addEventListener('click', async ()=>{
    const u = $('#url').value.trim(); if(!u) return alert('URL을 입력하세요');
    $('#go').disabled=true; $('#go').textContent='확인 중…'; show('요청 중…');
    try{
      // 직접 → 실패 시 프록시
      let txt=null, via='direct';
      try{ txt=await fetchText(norm(u)); }catch{}
      if(!txt){ txt=await fetchText(proxy(u)); via='proxy'; }
      const n = parseCount(txt||'');
      if(n!=null) show(`<span class="ok">${n}명</span> <span class="muted">(${via})</span>`,'ok');
      else show(`<span class="fail">파싱 실패</span><br><span class="muted">해당 방은 ‘참여하기’ 클릭 뒤에 숫자가 노출될 수 있어요.</span>`,'fail');
    }catch(e){ show(`<span class="fail">오류</span>: ${(e&&e.message)||e}`,'fail'); }
    finally{ $('#go').disabled=false; $('#go').textContent='인원수 체크'; }
  });
})();
</script>
</body></html>
