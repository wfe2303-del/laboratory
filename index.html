<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>신용카드 CSV → 정리 시트 (단일 소스 · 오래된→최신 정렬)</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse (CSV 파서) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Google Identity Services (OAuth 2.0) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API Client (Sheets) -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    .toast { position: fixed; right: 16px; bottom: 16px; padding: 10px 14px; border-radius: 10px; background: #0f172a; color:#fff; opacity: .96; box-shadow: 0 6px 20px rgba(0,0,0,.2); z-index: 1000; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .scroll-xy { overflow: auto; }
    table.preview { border-collapse: collapse; }
    table.preview td, table.preview th { border:1px solid #e5e7eb; padding:8px; white-space: nowrap; }
    .invalid { background:#fef2f2; color:#991b1b; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <header class="mb-6">
      <h1 class="text-xl md:text-2xl font-bold">신용카드 CSV → 정리 시트 <span class="text-xs align-top text-slate-500">단일 소스 · 오래된→최신(오름차순)</span></h1>
      <p class="text-sm text-slate-600 mt-1">카드 CSV 한 개를 업로드하면 <span class="font-semibold">정리 시트</span> 구조(B~N)로 변환 후, <b>K(결제시간)</b> 기준 <b>오름차순(오래된→최신)</b>으로 정렬해 미리보기/전송합니다.</p>
    </header>

    <!-- CSV 업로드 & 옵션 -->
    <section class="grid lg:grid-cols-2 gap-6 mb-6">
      <div class="space-y-3 bg-white border border-slate-200 rounded-xl p-4">
        <h2 class="font-semibold">① 카드 CSV 업로드</h2>
        <p class="text-xs text-slate-500">매핑 규칙: <b>A~J → 정리 B~K</b>, <b>K~L → 정리 M~N</b>, <b>L(결제수단) = "신용카드"</b></p>
        <input id="csvCard" type="file" accept="text/csv,.csv" class="block w-full text-sm" />
        <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="headCard" class="accent-blue-600" checked /> 첫 행은 헤더(건너뛰기)</label>
        <div class="text-xs text-slate-500">인코딩(UTF‑8/EUC‑KR/CP949) 자동 재시도 지원</div>
      </div>
      <div class="space-y-3 bg-white border border-slate-200 rounded-xl p-4">
        <h2 class="font-semibold">미리보기 / 전송 옵션</h2>
        <div class="flex items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="optHasHeader" class="accent-blue-600" checked /> 첫 행은 헤더</label>
          <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="optMaskPhone" class="accent-blue-600" /> 전화번호 마스킹(미리보기)</label>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold mb-1">Google 시트 URL 또는 ID</label>
            <input id="sheetUrl" type="text" class="w-full p-3 rounded-lg border border-slate-200 bg-white" placeholder="https://docs.google.com/spreadsheets/d/XXXXXXXXX/edit" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">추가 범위 (시트명)</label>
            <input id="rangeA1" type="text" class="w-full p-3 rounded-lg border border-slate-200 bg-white" placeholder="예: Sheet1" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button id="connectBtn" type="button" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Google 계정 연결</button>
          <select id="valueInputOption" class="p-3 rounded-lg border border-slate-200 bg-white">
            <option value="USER_ENTERED">USER_ENTERED (권장)</option>
            <option value="RAW">RAW</option>
          </select>
        </div>
        <div class="text-xs text-slate-500">전송 시 헤더는 자동 제외됩니다(옵션이 켜진 경우).</div>
      </div>
    </section>

    <div class="flex flex-wrap items-center gap-2 mb-6">
      <button id="btnPreviewCsv" type="button" class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-black">정리 미리보기</button>
      <button id="btnClear" type="button" class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-100">초기화</button>
      <button id="btnSend" type="button" class="px-3 py-2 rounded-lg bg-emerald-600 text-white disabled:opacity-50" disabled>Google 시트로 전송</button>
      <span id="authState" class="text-xs text-slate-600 ml-2">미연결</span>
    </div>

    <!-- Preview -->
    <section class="bg-white rounded-xl border border-slate-200 p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">정리 시트 미리보기 <span class="text-xs text-slate-400">(K열 오름차순 정렬)</span></h2>
        <div class="text-xs text-slate-500" id="summary"></div>
      </div>
      <div class="scroll-xy" style="max-height: 480px;">
        <table id="previewTable" class="preview text-sm"></table>
      </div>
    </section>

    <footer class="mt-6 text-xs text-slate-500">
      <p>시범용: 카드 CSV → 규칙 기반 정리(날짜 정렬) → 전송 플로우만 검증합니다. 민감정보는 테스트 시 가공/마스킹 권장.</p>
    </footer>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
  // ====== Config ======
  const OAUTH_CLIENT_ID = "18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com"; // TODO 교체
  const OAUTH_SCOPES   = "https://www.googleapis.com/auth/spreadsheets";

  // ====== State ======
  let tokenClient = null;
  let oauthReady = false;
  let parsedRows = [];
  let csv1Rows = []; // 카드 전용

  // ====== Helpers ======
  const $ = (q) => document.querySelector(q);
  const toast = (msg, type="info") => {
    const el = $("#toast"); if(!el) return;
    el.textContent = msg;
    el.classList.remove("hidden");
    el.style.background = type === 'error' ? '#991b1b' : (type === 'ok' ? '#065f46' : '#0f172a');
    setTimeout(() => el.classList.add("hidden"), 2600);
  };

  const equalizeRowLength = (rows) => {
    if (!rows.length) return rows;
    const maxLen = rows.reduce((m, r) => Math.max(m, r.length), 0);
    return rows.map(r => { const c = r.slice(); while (c.length < maxLen) c.push(''); return c; });
  };

  const maskPhones = (rows) => {
    const re1 = /(\b\d{3})(\d{4})(\d{4}\b)/g;
    const re2 = /(\b\d{2,3}-)(\d{3,4})(-\d{4}\b)/g;
    return rows.map(row => row.map(cell => {
      if (typeof cell !== 'string') return cell;
      let out = cell.replace(re1, (m, a, b, c) => `${a}****${c}`);
      out = out.replace(re2, (m, a, b, c) => `${a}****${c}`);
      return out;
    }));
  };

  const ensureArrayLen = (len) => { const arr = new Array(len); for (let i=0;i<len;i++) arr[i] = ''; return arr; };

  // 날짜 파서: 다양한 포맷 허용 (YYYY-MM-DD, YYYY.MM.DD, YYYY/MM/DD + HH:mm[:ss], 오전/오후 처리)
  function getTimeFromAny(val){
    if(!val) return -Infinity;
    const s0 = String(val).trim();
    if(!s0) return -Infinity;
    // 오전/오후 감지
    const pm = /오후/.test(s0);
    const am = /오전/.test(s0);
    // 숫자 추출 (연-월-일 [시:분:초] )
    const m = s0.match(/(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D+(\d{1,2})(?::(\d{1,2})(?::(\d{1,2}))?)?)?/);
    if(m){
      let [_, yy, MM, dd, hh, mm, ss] = m;
      let H = hh ? parseInt(hh,10) : 0;
      const Min = mm ? parseInt(mm,10) : 0;
      const Sec = ss ? parseInt(ss,10) : 0;
      if(pm && H < 12) H += 12; // 오후 보정
      if(am && H === 12) H = 0; // 오전 12시 -> 0시
      return new Date(parseInt(yy,10), parseInt(MM,10)-1, parseInt(dd,10), H, Min, Sec).getTime();
    }
    // ISO 등 일반 파서 시도
    const iso = s0.replace(/[./]/g,'-').replace('T',' ');
    const t = Date.parse(iso);
    return isNaN(t) ? -Infinity : t;
  }

  const renderPreview = (rows) => {
    const table = $('#previewTable');
    table.innerHTML = '';
    if (!rows.length) { $('#summary').textContent = '행 0'; return; }

    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');
    const colCount = rows[0].length;

    if (typeof __ensureAsc === 'function') __ensureAsc();
    const hasHeader = $('#optHasHeader').checked;
    if (hasHeader) {
      const tr = document.createElement('tr');
      rows[0].forEach((h, idx) => {
        const th = document.createElement('th');
        th.className = 'bg-slate-100 text-slate-700 font-semibold';
        th.textContent = h || `(col${idx+1})`;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
    }

    const startIdx = hasHeader ? 1 : 0;
    for (let r = startIdx; r < rows.length; r++) {
      const tr = document.createElement('tr');
      const row = rows[r];
      for (let c = 0; c < colCount; c++) {
        const td = document.createElement('td');
        const val = (row[c] ?? '').toString();
        if (row.length !== colCount) td.classList.add('invalid');
        td.textContent = val;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    table.appendChild(thead);
    table.appendChild(tbody);
    const bodyRows = Math.max(0, rows.length - (hasHeader?1:0));
    $('#summary').textContent = `열 ${colCount} · 데이터 행 ${bodyRows}`;
  };

  // ====== Google API ======
  async function ensureGapiLoaded() {
    await new Promise((resolve)=>{ const check=()=>{ if(window.gapi && gapi.load){ resolve(); } else setTimeout(check,50); }; check(); });
    await new Promise((resolve, reject)=>{ gapi.load('client', async ()=>{ try { await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4'); resolve(); } catch(e){ reject(e); } }); });
  }

  async function ensureAuth() {
    if (!window.google || !google.accounts || !google.accounts.oauth2) throw new Error('GIS not loaded');
    if (!tokenClient) {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: OAUTH_CLIENT_ID,
        scope: OAUTH_SCOPES,
        callback: (resp) => {
          if (resp && resp.access_token) {
            gapi.client.setToken({ access_token: resp.access_token });
            oauthReady = true; updateAuthUI(); toast('Google 계정 연결 완료', 'ok');
          } else toast('인증 실패', 'error');
        }
      });
    }
    if (!oauthReady) tokenClient.requestAccessToken({ prompt: 'consent' });
  }

  // ✅ A2부터 항상 추가되도록 수정된 함수
  async function appendToSheet(values) {
    const spreadsheetId = parseSpreadsheetId($('#sheetUrl').value);
    if (!spreadsheetId) { toast('스프레드시트 URL/ID를 입력하세요', 'error'); throw new Error('no sheet'); }
    const sheetName = ($('#rangeA1').value.trim() || 'Sheet1');
    const range = `${sheetName}!A2`;                  // ← A2 고정 시작
    const valueInputOption = $('#valueInputOption').value;
    const body = { range, majorDimension: 'ROWS', values };
    return await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId,
      range,
      valueInputOption,
      insertDataOption: 'INSERT_ROWS',
      resource: body,
    });
  }

  function parseSpreadsheetId(input){ if(!input) return ''; const m = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); return m && m[1] ? m[1] : input.trim(); }

  // ====== CSV 읽기 (인코딩/형식 견고화) ======
  function readCsv(file){
    return new Promise((resolve)=>{
      if(!file){ resolve([]); return; }
      Papa.parse(file, {
        complete: (res)=>{
          let rows = Array.isArray(res.data)? res.data : [];
          rows = rows.map(r => Array.isArray(r)? r : [r]);
          const count = rows.filter(r=> r.some(c=> String(c).trim()!==''));
          if(count>0){ resolve(rows); return; }
          // 인코딩 재시도
          const tryEncodings = ['UTF-8','EUC-KR','CP949','ISO-8859-1'];
          let idx = 0;
          const reader = new FileReader();
          reader.onload = () => {
            const text = reader.result || '';
            const parsed = Papa.parse(String(text), { skipEmptyLines:'greedy' });
            let rows2 = Array.isArray(parsed.data)? parsed.data : [];
            rows2 = rows2.map(r => Array.isArray(r)? r : [r]);
            const cnt2 = rows2.filter(r=> r.some(c=> String(c).trim()!==''));
            if(cnt2>0 || idx>=tryEncodings.length-1){ resolve(rows2); }
            else { idx++; reader.readAsText(file, tryEncodings[idx]); }
          };
          reader.onerror = ()=> resolve([]);
          reader.readAsText(file, tryEncodings[idx]);
        },
        error: ()=>{
          const reader = new FileReader();
          reader.onload = ()=>{
            const parsed = Papa.parse(String(reader.result||''), { skipEmptyLines:'greedy' });
            let rows3 = Array.isArray(parsed.data)? parsed.data : [];
            rows3 = rows3.map(r => Array.isArray(r)? r : [r]);
            resolve(rows3);
          };
          reader.onerror = ()=> resolve([]);
          reader.readAsText(file, 'UTF-8');
        },
        skipEmptyLines: 'greedy'
      });
    });
  }

  // ====== 정리 규칙 (카드 전용) ======
  function buildHeader(){
    return [
      'A',                 // (미사용)
      'B',                 // 카드 A →
      'C',
      'D',
      'E',
      'F',
      'G',
      'H(결제금액)',
      'I(상태)',
      'J',
      'K(결제시간)',
      'L(결제수단=신용카드)',
      'M(카드 원본 K)',
      'N(카드 원본 L)',
      'O(예비)'
    ];
  }

  function processCardRows(rows, skipHeader=true){
    const out = [];
    const start = skipHeader ? 1 : 0;
    for(let i=start;i<rows.length;i++){
      const r = rows[i] || [];
      if (r.length===0 || r.every(x => String(x).trim()==='')) continue;
      const o = ensureArrayLen(15);
      // A..J → B..K
      for(let j=0;j<10;j++){ o[1+j] = r[j] ?? ''; }
      // 결제수단 L 고정값
      o[11] = '신용카드';
      // K..L → M..N
      o[12] = r[10] ?? o[12];
      o[13] = r[11] ?? o[13];
      out.push(o);
    }
    return out;
  }

  function dateKeyFromRow(row){
    const candidates = [row[12], row[10], row[9], row[8], row[7], row[6], row[5], row[4], row[3], row[2], row[1]];
    for (const v of candidates) {
      const t = getTimeFromAny(v);
      if (Number.isFinite(t)) return t;
    }
    return Infinity;
  }

  function buildFinalRows(){
    const header = buildHeader();
    let finalRows = [];
    if(csv1Rows.length){ finalRows = finalRows.concat(processCardRows(csv1Rows, $('#headCard').checked)); }
    // === 날짜정렬(오름차순): K열(인덱스 10) 기준 오래된→최신 ===
    finalRows.sort((a,b)=> dateKeyFromRow(a) - dateKeyFromRow(b));
    parsedRows = [header, ...finalRows];
    $('#optHasHeader').checked = true;
  }

  // 강제 오름차순 정렬 보조 함수 (미리보기/전송 직전 안전망)
  function __ensureAsc(){
    try{
      if(!Array.isArray(parsedRows) || parsedRows.length<=1) return;
      const header = parsedRows[0];
      const body = parsedRows.slice(1).slice();
      // 후보: M(12) → K(10) → 왼쪽으로 스캔
      const key = (row)=>{
        const candidates = [row[12], row[10], row[9], row[8], row[7], row[6], row[5], row[4], row[3], row[2], row[1]];
        for(const v of candidates){
          const t = getTimeFromAny(v);
          if(Number.isFinite(t)) return t;
        }
        return Infinity;
      };
      body.sort((a,b)=> key(a) - key(b));
      parsedRows = [header, ...body];
    }catch(e){ console.error('[ensureAsc]', e); }
  }

  // ====== Events ======
  window.addEventListener('error', (e)=>{ toast('오류: '+(e?.error?.message || e.message || '알 수 없는 오류'), 'error'); });
  window.addEventListener('unhandledrejection', (e)=>{ toast('처리되지 않은 오류: '+(e?.reason?.message || e.reason || '알 수 없는 오류'), 'error'); });

  document.addEventListener('DOMContentLoaded', () => {
    // 파일 업로드 (인코딩 대응, 재업로드 허용)
    $('#csvCard').addEventListener('change', async (e) => {
      try{
        const f = e.target.files && e.target.files[0];
        if(!f){ toast('카드 CSV 선택이 비었습니다', 'error'); return; }
        const rows = await readCsv(f);
        csv1Rows = rows;
        const nonEmpty = rows.filter(r=> Array.isArray(r) && r.some(c=> String(c).trim()!==''));
        toast(`카드 CSV 로드: ${rows.length}행 (유효 ${nonEmpty.length}행)`, nonEmpty.length? 'ok':'error');
      }catch(err){ console.error(err); toast('카드 CSV 읽기 실패', 'error'); }
      finally{ e.target.value=''; }
    }, {capture:true});

    $('#btnPreviewCsv').addEventListener('click', (e) => {
      e.preventDefault();
      try{
        if(!csv1Rows.length){ parsedRows=[buildHeader()]; renderPreview(parsedRows); toast('CSV를 업로드하세요 (헤더만 표시)', 'error'); return; }
        buildFinalRows();
        if (typeof __ensureAsc === 'function') __ensureAsc();
        let rows = parsedRows;
        if ($('#optMaskPhone').checked) rows = maskPhones(rows);
        rows = equalizeRowLength(rows);
        renderPreview(rows);
        toast('미리보기 갱신 (날짜 오름차순)', 'ok');
      }catch(e2){ console.error(e2); toast('정리 실패: 콘솔 확인', 'error'); }
    });

    $('#btnClear').addEventListener('click', (e) => {
      e.preventDefault();
      csv1Rows = []; parsedRows = [];
      $('#csvCard').value = '';
      $('#previewTable').innerHTML='';
      $('#summary').textContent = '';
      toast('초기화 완료');
    });

    // Google 연결/전송
    $('#connectBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      try{
        if (OAUTH_CLIENT_ID.startsWith('REPLACE_WITH')) { toast('OAuth 클라이언트 ID를 설정해 주세요.', 'error'); return; }
        await ensureGapiLoaded();
        await ensureAuth();
        $('#btnSend').disabled = false;
      }catch(err){ console.error(err); toast('Google 연결 실패', 'error'); }
    });

    $('#btnSend').addEventListener('click', async (e) => {
      e.preventDefault();
      try{
        await ensureGapiLoaded();
        if(!oauthReady){ toast('먼저 Google 계정 연결을 해주세요', 'error'); return; }
        if (!parsedRows.length) { toast('먼저 정리 미리보기를 실행하세요', 'error'); return; }
        const hasHeader = $('#optHasHeader').checked;
        const rowsToSend = hasHeader ? parsedRows.slice(1) : parsedRows;
        if (!rowsToSend.length) { toast('전송할 데이터 행이 없습니다', 'error'); return; }
        $('#btnSend').disabled = true;
        const res = await appendToSheet(rowsToSend);
        const updates = res.result && res.result.updates ? res.result.updates.updatedRows : undefined;
        toast(`전송 완료: ${updates ?? rowsToSend.length}행`, 'ok');
      }catch(err){ console.error(err); toast('전송 실패: 콘솔 확인', 'error'); }
      finally{ $('#btnSend').disabled = false; }
    });

    window.updateAuthUI = () => { $('#authState').textContent = oauthReady ? '연결됨' : '미연결'; };
  });
  </script>
  <script id="kr-date">
    (function(){
      function splitSpaces(str){
        var arr=[], cur='';
        for(var i=0;i<str.length;i++){
          var code=str.charCodeAt(i);
          var isSpace = code<=32;
          if(isSpace){ if(cur){ arr.push(cur); cur=''; } }
          else { cur += str.charAt(i); }
        }
        if(cur) arr.push(cur);
        return arr;
      }
      window.getTimeFromAny = function(val){
        if(val===undefined || val===null) return NaN;
        var s = String(val).trim();
        if(!s) return NaN;
        var hasAm = s.indexOf('오전')>=0;
        var hasPm = s.indexOf('오후')>=0;
        if(hasAm || hasPm){
          var marker = hasAm ? '오전' : '오후';
          var parts = s.split(marker);
          var dPart = parts[0] || '';
          var tPart = (parts[1] || '').trim();
          var tPieces = tPart.split(':');
          var hh = parseInt(tPieces[0]||'0',10);
          var mm = parseInt(tPieces[1]||'0',10);
          var ss = parseInt(tPieces[2]||'0',10);
          if(hasPm && hh<12) hh+=12;
          if(hasAm && hh===12) hh=0;
          var onlyNums = '';
          for(var i=0;i<dPart.length;i++){
            var ch = dPart.charAt(i);
            if(ch>='0' && ch<='9') onlyNums += ch; else onlyNums += ' ';
          }
          var tokens = splitSpaces(onlyNums);
          var yy = parseInt(tokens[0]||'0',10);
          var MM = parseInt(tokens[1]||'1',10);
          var dd = parseInt(tokens[2]||'1',10);
          var dt = new Date(yy, MM-1, dd, hh, mm, ss).getTime();
          return isNaN(dt) ? NaN : dt;
        }
        var iso = s.split('.').join('-').split('/').join('-').replace('T',' ');
        var time = Date.parse(iso);
        return isNaN(time) ? NaN : time;
      };
    })();
  </script>
</body>
</html>
